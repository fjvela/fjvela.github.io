<!doctype html><html lang=es dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes - Vertical Pod Autoscaler | Javi Vela Blog</title><meta name=keywords content="kubernetes,k8s,autoscaler"><meta name=description content="La escalabilidad vertical permite aumentar la memoria y CPU de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes."><meta name=author content="Javi Vela"><link rel=canonical href=https://blog.javivela.dev/posts/2023/kubernetes/vertical-pod-autoscaler/><meta name=google-site-verification content="Z9k5TW79n5H64zWLwEcNkbNITNDDepKoE2udZjirxXM"><meta name=msvalidate.01 content="6A293DF736526A40A24D911811A73F7D"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.javivela.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.javivela.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.javivela.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.javivela.dev/apple-touch-icon.png><link rel=mask-icon href=https://blog.javivela.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=es href=https://blog.javivela.dev/posts/2023/kubernetes/vertical-pod-autoscaler/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.javivela.dev/posts/2023/kubernetes/vertical-pod-autoscaler/"><meta property="og:site_name" content="Javi Vela Blog"><meta property="og:title" content="Kubernetes - Vertical Pod Autoscaler"><meta property="og:description" content="La escalabilidad vertical permite aumentar la memoria y CPU de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes."><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-18T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="K8S"><meta property="article:tag" content="Autoscaler"><meta property="og:image" content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:title content="Kubernetes - Vertical Pod Autoscaler"><meta name=twitter:description content="La escalabilidad vertical permite aumentar la memoria y CPU de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.javivela.dev/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes - Vertical Pod Autoscaler","item":"https://blog.javivela.dev/posts/2023/kubernetes/vertical-pod-autoscaler/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes - Vertical Pod Autoscaler","name":"Kubernetes - Vertical Pod Autoscaler","description":"La escalabilidad vertical permite aumentar la memoria y CPU de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes.","keywords":["kubernetes","k8s","autoscaler"],"articleBody":"Una de las mayores ventajas del uso de Kubernetes (K8S) para ejecutar nuestras aplicaciones es la escalabilidad, gracias a ella podemos gestionar los recursos de una manera más eficiente.\nExisten dos tipos de escalabilidad:, la escalabilidad horizontal, que aumenta el número de réplicas (Deployments o Stateful) de nuestra aplicación dependiendo del uso de memoria y CPU de la aplicación. Si el consumo de CPU y/o memoria aumenta, el número de réplicas aumentará, y si disminuye, disminuirá el número de réplicas de la aplicación. En Kubernetes, el HPA (Horizontal Pod Autoscaler) es el encargado de monitorizar y escalar horizontalmente las aplicaciones.\nLa escalabilidad vertical permite aumentar la memoria y CPU de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes.\nVertical Pod Autoscaler (VPA) Consta de tres componentes:\nRecommender: es el componente principal del VPA, cuya misión es generar recomendaciones de asignación de CPU y memoria basados en el histórico y consumo actual de CPU y memoria. Updater: decide qué Pods deben ser reiniciados basándose en los datos del recommender. Si se debe ajustar la CPU y memoria de un pod, intentará terminar su ejecución (revisando Pod Disruption Budget (PDB)) - evento EvictedByVPA . La actualización de la asignación de los recursos es realizada por el Admission Controller. Admission Controller: por cada Pod creado en el clúster, comprueba si debe realizar una actualización de los recursos asignados basándose en la configuración y recomendaciones del VPA (si la hay).\nObjecto VPA (Vertical Pod Autoscaler) Para poder definir el comportamiento del VPA para nuestros Pods es necesario crear un recurso de tipo VerticalPodAutoscaler:\napiVersion: \"autoscaling.k8s.io/v1\" kind: VerticalPodAutoscaler metadata: name: hamster-vpa spec: targetRef: apiVersion: \"apps/v1\" kind: Deployment name: hamster updatePolicy: updateMode: \"Auto\" resourcePolicy: containerPolicies: - containerName: '*' minAllowed: cpu: 100m memory: 50Mi maxAllowed: cpu: 1 memory: 500Mi controlledResources: [\"cpu\", \"memory\"] targetRef: Indicaremos el recurso sobre el que el VPA actuará: kind: tipo de controlador (ej.: deployment o daemonset) que controla los Pods a monitorizar y actualizar los recursos asignados a los Pods name: nombre del recurso containerPolicies: containerName: Nombre del contenedor (podemos usar * para aplicar la configuración a todos los containers del pod) minAllowed: Los recursos mínimos que el VPA puede asignar al container (CPU y/o memoria) maxAllowed: Los recursos máximos que el VPA puede asignar al container (CPU y/o memoria) controlledResources: El tipo de recurso o recusos a monitorizar (CPU y/o memoria) updatePolicy: VPA ofrece cuatro modos para aplicar las recomendaciones de asignación de CPU y memoria: Off: El recommender calcula las recomendaciones de asignación de recursos pero el updater nunca reinicia los Pods para aplicar los cambios (modo “dry-run”) Initial: Solo se se asignan las recomendaciones cuando se crea el pod, no se realiza ningún cambio durante el ciclo de vida del mismo Recreate: El VPA puede asignar las recomendaciones cuando se crea el Pod y durante su ciclo de vida Auto: Actualmente equivale a la opción Recreate ya que es el unico metodo de actualización disponible (valor por defecto) Instalación A día de hoy, VPA no está incluido como un componente en Kubernetes por lo que es necesario instalarlo desde su repositorio.\n⚠️ Revisa las instrucciones de instalación, es posible que hayan cambiado.\nMinikube Desplegar los componentes del VPA es muy sencillo:\nClonaremos el repositorio https://github.com/kubernetes/autoscaler/tree/master Ejecutamos el comando ./hack/vpa-up.sh desde la carpeta vertical-pod-autoscaler Azure (Azure Kubernetes Service) Azure permite habilitar/deshabilitar Vertical Pod Autoscaler en un clúster AKS. Para ello, debemos registrar el “feature flag” AKS-VPAPreview en nuestra subscripción utilizando el siguiente comando: az feature register --namespace \"Microsoft.ContainerService\" --name \"AKS-VPAPreview\".\nUna vez registrado, podemos utilizar Terraform, Bicep o az cli para desplegar automáticamente VPA en nuestro clúster.\nSi estás utilizando Terraform, asegúrate de usar al menos la versión 3.47 de terraform-provider-azurerm y agrega el siguiente bloque de código al recurso azurerm_kubernetes_cluster:\nworkload_autoscaler_profile { vertical_pod_autoscaler_enabled = true } Puedes utilizar el código de Terraform de este repositorio para desplegar un clúster AKS con el componente VPA desplegado. Para facilitar la prueba, el clúster es público.\n⚠️ ¡No utilices este código para desplegar un clúster en un entorno productivo! Recuerda borrarlo una vez finalizadas las pruebas para evitar problemas y/o costes innecesarios.\nSi utilizas Bicep, puedes encontrar cómo habilitarlo en el siguiente enlace: https://learn.microsoft.com/en-us/azure/templates/microsoft.containerservice/managedclusters?pivots=deployment-language-bicep#managedclusterworkloadautoscalerprofileverticalpodau\nTambién puedes utilizar la línea de comandos az, puedes consultar los comandos necesarios en el enlace: https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#deploy-upgrade-or-disable-vpa-on-a-cluster\nTen en cuenta que la versión desplegada por Azure es una versión del Vertical Pod Autoscaler modificada por Microsoft, su funcionamiento y rendimiento deberían ser mejores y optimizados para trabajar en un clúster AKS.\nComprobación de la instalación Los componentes se instalan en el namespace kube-system, comprobamos que los tres componentes están arrancados y funcionan sin problema (kubectl get pods -l 'app in( vpa-admission-controller, vpa-recommender, vpa-updater)' -n kube-system)):\nFuncionamiento El siguiente paso es ejecutar un ejemplo para poder revisar el funcionamiento del VPA en el clúster, en el propio repositorio podemos encontrar el siguiente ejemplo:\napiVersion: \"autoscaling.k8s.io/v1\" kind: VerticalPodAutoscaler metadata: name: hamster-vpa spec: targetRef: apiVersion: \"apps/v1\" kind: Deployment name: hamster updatePolicy: updateMode: \"Auto\" resourcePolicy: containerPolicies: - containerName: '*' minAllowed: cpu: 100m memory: 50Mi maxAllowed: cpu: 1 memory: 500Mi controlledResources: [\"cpu\", \"memory\"] --- apiVersion: apps/v1 kind: Deployment metadata: name: hamster spec: selector: matchLabels: app: hamster replicas: 2 template: metadata: labels: app: hamster spec: securityContext: runAsNonRoot: true runAsUser: 65534 # nobody containers: - name: hamster image: registry.k8s.io/ubuntu-slim:0.1 resources: requests: cpu: 100m memory: 50Mi command: [\"/bin/sh\"] args: - \"-c\" - \"while true; do timeout 0.5s yes \u003e/dev/null; sleep 0.5s; done\" En el ejemplo, podemos ver la definición de un objeto VPA, el cual actuará sobre el Deployment hamster y monitorizará tanto la memoria como la CPU consumida por los pods del deployment. Los recursos mínimos y máximos que podrá asignar son los siguientes:\nMínimo Máximo CPU 100m 1 Memoria 50Mi 500Mi Logs recommender Cada 1 minuto, el recommender comprueba las métricas y calcula si es necesario realizar una actualización de los recursos:\nI0515 16:59:00.167961 1 recommender.go:168] Recommender Run I0515 16:59:00.168058 1 cluster_feeder.go:355] Start selecting the vpaCRDs. I0515 16:59:00.168066 1 cluster_feeder.go:390] Fetched 1 VPAs. I0515 16:59:00.168093 1 cluster_feeder.go:400] Using selector app=hamster for VPA default/hamster-vpa I0515 16:59:00.174398 1 metrics_client.go:77] 11 podMetrics retrieved for all namespaces I0515 16:59:00.174452 1 cluster_feeder.go:478] ClusterSpec fed with #22 ContainerUsageSamples for #11 containers. Dropped #0 samples. I0515 16:59:00.174460 1 recommender.go:178] ClusterState is tracking 13 PodStates and 1 VPAs I0515 16:59:00.194835 1 checkpoint_writer.go:114] Saved VPA default/hamster-vpa checkpoint for hamster I0515 16:59:00.194867 1 cluster.go:362] Garbage collection of AggregateCollectionStates triggered I0515 16:59:00.194890 1 recommender.go:188] ClusterState is tracking 12 aggregated container states Cuando se genera una recomendación, se puede consultar en el objeto VPA. Para ello ejecutamos el comando kubectl get vpa -o=jsonpath='{.items[0].status}' | jq :\nLogs updater En el caso de que haya una recomendación por parte del recommender, el updater eliminará los Pods asociados al deployment (razón: EvictedByVPA ). Este proceso también se ejecuta cada 1 minuto.\nI0515 17:11:06.957414 1 api.go:92] Initial VPA synced successfully I0515 17:11:06.957601 1 reflector.go:221] Starting reflector *v1.Pod (1h0m0s) from k8s.io/autoscaler/vertical-pod-autoscaler/pkg/updater/logic/updater.go:289 I0515 17:11:06.957675 1 reflector.go:257] Listing and watching *v1.Pod from k8s.io/autoscaler/vertical-pod-autoscaler/pkg/updater/logic/updater.go:289 I0515 17:12:06.959731 1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-mc9f5 with priority 8.870000000000001 I0515 17:12:06.959861 1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-jqblb with priority 8.870000000000001 I0515 17:12:06.959890 1 updater.go:215] evicting pod hamster-65cd4dd797-mc9f5 I0515 17:12:06.976619 1 event.go:285] Event(v1.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"hamster-65cd4dd797-mc9f5\", UID:\"d22d508d-26f4-4d89-b371-edd744018f57\", APIVersion:\"v1\", ResourceVersion:\"118847\", FieldPath:\"\"}): type: 'Normal' reason: 'EvictedByVPA' Pod was evicted by VPA Updater to apply resource recommendation. I0515 17:13:06.951468 1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-jqblb with priority 8.870000000000001 I0515 17:13:06.951508 1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-jxgtj, request within recommended range I0515 17:13:06.951520 1 updater.go:215] evicting pod hamster-65cd4dd797-jqblb I0515 17:13:06.969737 1 event.go:285] Event(v1.ObjectReference{Kind:\"Pod\", Namespace:\"default\", Name:\"hamster-65cd4dd797-jqblb\", UID:\"c7de721e-cc47-4906-8c15-10b4e4725b82\", APIVersion:\"v1\", ResourceVersion:\"118845\", FieldPath:\"\"}): type: 'Normal' reason: 'EvictedByVPA' Pod was evicted by VPA Updater to apply resource recommendation. I0515 17:14:06.949563 1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-jxgtj, request within recommended range I0515 17:14:06.949598 1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-qj6tg, request within recommended range Con el comando kubectl get event --field-selector reason=EvictedByVPA podemos comprobar los eventos de borrado de los Pods para poder asignarles los nuevos recursos:\nLogs Admission Controller Todas las solicitudes de creación de un nuevo Pod son enviadas a los admission controller desplegados en el clúster. En nuestro caso, comprobará si es necesario actualizar los recursos asignados al pod:\nI0515 17:11:27.569672 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 0 0001-01-01 00:00:00 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000596d20 0xc00068cd80 []} { []}} I0515 17:11:27.598513 1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default 0 0001-01-01 00:00:00 +0000 UTC map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc000320d27 0xc000320d28}] [] [{kube-controller-manager Update v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:generateName\":{},\"f:labels\":{\".\":{},\"f:app\":{},\"f:pod-template-hash\":{}},\"f:ownerReferences\":{\".\":{},\"k:{\\\"uid\\\":\\\"bf57314a-36a6-48fd-a297-269d21f364a4\\\"}\":{}}},\"f:spec\":{\"f:containers\":{\"k:{\\\"name\\\":\\\"hamster\\\"}\":{\".\":{},\"f:args\":{},\"f:command\":{},\"f:image\":{},\"f:imagePullPolicy\":{},\"f:name\":{},\"f:resources\":{\".\":{},\"f:requests\":{\".\":{},\"f:cpu\":{},\"f:memory\":{}}},\"f:terminationMessagePath\":{},\"f:terminationMessagePolicy\":{}}},\"f:dnsPolicy\":{},\"f:enableServiceLinks\":{},\"f:restartPolicy\":{},\"f:schedulerName\":{},\"f:securityContext\":{\".\":{},\"f:runAsNonRoot\":{},\"f:runAsUser\":{}},\"f:terminationGracePeriodSeconds\":{}}} }]} I0515 17:11:27.598984 1 matcher.go:68] Let's choose from 1 configs for pod default/hamster-65cd4dd797-% I0515 17:11:27.600342 1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%. I0515 17:11:27.600588 1 recommendation_provider.go:57] no matching recommendation found for container hamster, skipping I0515 17:11:27.600671 1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: } {add /metadata/annotations/vpaObservedContainers hamster}] I0515 17:11:27.609234 1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default 0 0001-01-01 00:00:00 +0000 UTC map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc00080c927 0xc00080c928}] [] [{kube-controller-manager Update v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:generateName\":{},\"f:labels\":{\".\":{},\"f:app\":{},\"f:pod-template-hash\":{}},\"f:ownerReferences\":{\".\":{},\"k:{\\\"uid\\\":\\\"bf57314a-36a6-48fd-a297-269d21f364a4\\\"}\":{}}},\"f:spec\":{\"f:containers\":{\"k:{\\\"name\\\":\\\"hamster\\\"}\":{\".\":{},\"f:args\":{},\"f:command\":{},\"f:image\":{},\"f:imagePullPolicy\":{},\"f:name\":{},\"f:resources\":{\".\":{},\"f:requests\":{\".\":{},\"f:cpu\":{},\"f:memory\":{}}},\"f:terminationMessagePath\":{},\"f:terminationMessagePolicy\":{}}},\"f:dnsPolicy\":{},\"f:enableServiceLinks\":{},\"f:restartPolicy\":{},\"f:schedulerName\":{},\"f:securityContext\":{\".\":{},\"f:runAsNonRoot\":{},\"f:runAsUser\":{}},\"f:terminationGracePeriodSeconds\":{}}} }]} I0515 17:11:27.609377 1 matcher.go:68] Let's choose from 1 configs for pod default/hamster-65cd4dd797-% I0515 17:11:27.609391 1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%. I0515 17:11:27.609399 1 recommendation_provider.go:57] no matching recommendation found for container hamster, skipping I0515 17:11:27.609444 1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: } {add /metadata/annotations/vpaObservedContainers hamster}] I0515 17:12:00.170779 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 118818 1 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:12:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000411b90 0xc00088c378 []} {0xc00088c450 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:12:06.982108 1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default 0 0001-01-01 00:00:00 +0000 UTC map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc0008a2157 0xc0008a2158}] [] [{kube-controller-manager Update v1 2023-05-15 17:12:06 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:generateName\":{},\"f:labels\":{\".\":{},\"f:app\":{},\"f:pod-template-hash\":{}},\"f:ownerReferences\":{\".\":{},\"k:{\\\"uid\\\":\\\"bf57314a-36a6-48fd-a297-269d21f364a4\\\"}\":{}}},\"f:spec\":{\"f:containers\":{\"k:{\\\"name\\\":\\\"hamster\\\"}\":{\".\":{},\"f:args\":{},\"f:command\":{},\"f:image\":{},\"f:imagePullPolicy\":{},\"f:name\":{},\"f:resources\":{\".\":{},\"f:requests\":{\".\":{},\"f:cpu\":{},\"f:memory\":{}}},\"f:terminationMessagePath\":{},\"f:terminationMessagePolicy\":{}}},\"f:dnsPolicy\":{},\"f:enableServiceLinks\":{},\"f:restartPolicy\":{},\"f:schedulerName\":{},\"f:securityContext\":{\".\":{},\"f:runAsNonRoot\":{},\"f:runAsUser\":{}},\"f:terminationGracePeriodSeconds\":{}}} }]} I0515 17:12:06.982216 1 matcher.go:68] Let's choose from 1 configs for pod default/hamster-65cd4dd797-% I0515 17:12:06.982226 1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%. I0515 17:12:06.983687 1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /spec/containers/0/resources/requests/cpu 587m} {add /spec/containers/0/resources/requests/memory 262144k} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: cpu request, memory request} {add /metadata/annotations/vpaObservedContainers hamster}] I0515 17:13:00.163171 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 118878 2 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:13:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc0007366f0 0xc00080e708 []} {0xc00080e7e0 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:13:06.976062 1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default 0 0001-01-01 00:00:00 +0000 UTC map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc0008a2427 0xc0008a2428}] [] [{kube-controller-manager Update v1 2023-05-15 17:13:06 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:generateName\":{},\"f:labels\":{\".\":{},\"f:app\":{},\"f:pod-template-hash\":{}},\"f:ownerReferences\":{\".\":{},\"k:{\\\"uid\\\":\\\"bf57314a-36a6-48fd-a297-269d21f364a4\\\"}\":{}}},\"f:spec\":{\"f:containers\":{\"k:{\\\"name\\\":\\\"hamster\\\"}\":{\".\":{},\"f:args\":{},\"f:command\":{},\"f:image\":{},\"f:imagePullPolicy\":{},\"f:name\":{},\"f:resources\":{\".\":{},\"f:requests\":{\".\":{},\"f:cpu\":{},\"f:memory\":{}}},\"f:terminationMessagePath\":{},\"f:terminationMessagePolicy\":{}}},\"f:dnsPolicy\":{},\"f:enableServiceLinks\":{},\"f:restartPolicy\":{},\"f:schedulerName\":{},\"f:securityContext\":{\".\":{},\"f:runAsNonRoot\":{},\"f:runAsUser\":{}},\"f:terminationGracePeriodSeconds\":{}}} }]} I0515 17:13:06.976162 1 matcher.go:68] Let's choose from 1 configs for pod default/hamster-65cd4dd797-% I0515 17:13:06.976171 1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%. I0515 17:13:06.976209 1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /spec/containers/0/resources/requests/cpu 587m} {add /spec/containers/0/resources/requests/memory 262144k} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: cpu request, memory request} {add /metadata/annotations/vpaObservedContainers hamster}] I0515 17:14:00.160455 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 118956 3 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:14:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc00042ff40 0xc0006a0510 []} {0xc0006a05e8 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:15:00.165045 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 119037 4 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:15:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc00037b320 0xc00088c750 []} {0xc00088c828 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:16:00.159714 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 119092 5 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:16:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000597e10 0xc0005610b0 []} {0xc000561188 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:16:33.741189 1 reflector.go:559] k8s.io/autoscaler/vertical-pod-autoscaler/pkg/target/fetcher.go:94: Watch close - *v1.DaemonSet total 6 items received I0515 17:16:43.942408 1 reflector.go:559] k8s.io/client-go/informers/factory.go:134: Watch close - *v1.LimitRange total 7 items received I0515 17:17:00.163545 1 handler.go:91] Processing vpa: \u0026{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa default 49f80082-26b4-4511-b096-b2e5a477b34d 119147 6 2023-05-15 17:11:27 +0000 UTC map[] map[kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"autoscaling.k8s.io/v1\",\"kind\":\"VerticalPodAutoscaler\",\"metadata\":{\"annotations\":{},\"name\":\"hamster-vpa\",\"namespace\":\"default\"},\"spec\":{\"resourcePolicy\":{\"containerPolicies\":[{\"containerName\":\"*\",\"controlledResources\":[\"cpu\",\"memory\"],\"maxAllowed\":{\"cpu\":1,\"memory\":\"500Mi\"},\"minAllowed\":{\"cpu\":\"100m\",\"memory\":\"50Mi\"}}]},\"targetRef\":{\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"name\":\"hamster\"},\"updatePolicy\":{\"updateMode\":\"Auto\"}}} ] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:kubectl.kubernetes.io/last-applied-configuration\":{}}},\"f:spec\":{\".\":{},\"f:resourcePolicy\":{\".\":{},\"f:containerPolicies\":{}},\"f:targetRef\":{},\"f:updatePolicy\":{\".\":{},\"f:updateMode\":{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:17:00 +0000 UTC FieldsV1 {\"f:status\":{\".\":{},\"f:conditions\":{},\"f:recommendation\":{\".\":{},\"f:containerRecommendations\":{}}}} }]} {\u0026CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc0004112c0 0xc000560390 []} {0xc000560468 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC }]}} I0515 17:17:00.846076 1 reflector.go:559] k8s.io/autoscaler/vertical-pod-autoscaler/pkg/target/fetcher.go:94: Watch close - *v1.Deployment total 20 items received Comprobamos las anotaciones de los Pods con el comando kubectl get pods -o=jsonpath='{.items[0].metadata.annotations}' | jq:\nComprobamos los nuevos recursos asignados con el comando kubectl get pods -o=jsonpath='{.items[0].spec.containers[0].resources}' | jq:\nLimitaciones Actualmente el estado del componente se encuentra en estado beta y tiene algunas limitaciones conocidas:\nCada vez que se actualizan los recursos, los Pods son recreados VPA no garantiza que una vez eliminados los Pods estos se puedan recrear (ej. no hay espacio suficiente en el nodepool) La escalabilidad vertical no debe utilizarse junto con la escalabilidad horizontal Antes de utilizar VPA, debemos comprobar los Admission controllers existentes Conclusión No en todos los casos de uso podemos hacer uso del Horizontal Pod Autoscaler (HPA) para escalar nuestras aplicaciones en clúster Kubernetes, aunque actualmente la escalabilidad vertical disponible en Kubernetes se encuentra en fase beta y tiene algunas limitaciones, creo que en el futuro se hará un mayor uso de ella, ya que combinada con una buena monitorización, una buena configuración del clúster autoscaler y un buen ajuste del tamaño de los nodepools del clúster podremos optimizar de manera muy efectiva los recursos hardware y a su vez los costes de los mismos.\nReferences https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#register-the-aks-vpapreview-feature-flag ","wordCount":"2337","inLanguage":"es","image":"https://blog.javivela.dev/papermod-cover.png","datePublished":"2023-05-18T00:00:00Z","dateModified":"2023-05-18T00:00:00Z","author":{"@type":"Person","name":"Javi Vela"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.javivela.dev/posts/2023/kubernetes/vertical-pod-autoscaler/"},"publisher":{"@type":"Organization","name":"Javi Vela Blog","logo":{"@type":"ImageObject","url":"https://blog.javivela.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.javivela.dev/ accesskey=h title="Javi Vela Blog (Alt + H)">Javi Vela Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.javivela.dev/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.javivela.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.javivela.dev/archives/ title=Archivos><span>Archivos</span></a></li><li><a href=https://blog.javivela.dev/search/ title=Buscar><span>Buscar</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.javivela.dev/>Inicio</a>&nbsp;»&nbsp;<a href=https://blog.javivela.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Kubernetes - Vertical Pod Autoscaler</h1><div class=post-meta><span title='2023-05-18 00:00:00 +0000 UTC'>mayo 18, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Javi Vela</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Tabla de Contenidos</span></summary><div class=inner><ul><li><a href=#vertical-pod-autoscaler-vpa aria-label="Vertical Pod Autoscaler (VPA)">Vertical Pod Autoscaler (VPA)</a><ul><li><a href=#objecto-vpa-vertical-pod-autoscaler aria-label="Objecto VPA (Vertical Pod Autoscaler)">Objecto VPA (Vertical Pod Autoscaler)</a></li><li><a href=#instalaci%c3%b3n aria-label=Instalación>Instalación</a><ul><li><a href=#minikube aria-label=Minikube>Minikube</a></li><li><a href=#azure-azure-kubernetes-service aria-label="Azure (Azure Kubernetes Service)">Azure (Azure Kubernetes Service)</a></li><li><a href=#comprobaci%c3%b3n-de-la-instalaci%c3%b3n aria-label="Comprobación de la instalación">Comprobación de la instalación</a></li></ul></li><li><a href=#funcionamiento aria-label=Funcionamiento>Funcionamiento</a><ul><li><a href=#logs-recommender aria-label="Logs recommender">Logs recommender</a></li><li><a href=#logs-updater aria-label="Logs updater">Logs updater</a></li><li><a href=#logs-admission-controller aria-label="Logs Admission Controller">Logs Admission Controller</a></li></ul></li><li><a href=#limitaciones aria-label=Limitaciones>Limitaciones</a></li><li><a href=#conclusi%c3%b3n aria-label=Conclusión>Conclusión</a></li><li><a href=#references aria-label=References>References</a></li></ul></li></ul></div></details></div><div class=post-content><p>Una de las mayores ventajas del uso de Kubernetes (K8S) para ejecutar nuestras aplicaciones es la <strong>escalabilidad</strong>, gracias a ella podemos gestionar los recursos de una manera más eficiente.</p><p>Existen dos tipos de escalabilidad:, la <strong>escalabilidad horizontal</strong>, que aumenta el <strong>número de réplicas</strong> (Deployments o Stateful) de nuestra aplicación dependiendo del uso de memoria y CPU de la aplicación. Si el consumo de CPU y/o memoria aumenta, el número de réplicas aumentará, y si disminuye, disminuirá el número de réplicas de la aplicación. En Kubernetes, el <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>HPA (Horizontal Pod Autoscaler)</a> es el encargado de monitorizar y escalar horizontalmente las aplicaciones.</p><p>La <strong>escalabilidad vertical</strong> permite <strong>aumentar la memoria y CPU</strong> de las réplicas dinámicamente dependiendo del uso de memoria y CPU de la aplicación. El componente VPA (Vertical Pod Autoscaler) permite realizar estos cambios automáticamente en nuestro clúster Kubernetes.</p><h2 id=vertical-pod-autoscaler-vpa>Vertical Pod Autoscaler (VPA)<a hidden class=anchor aria-hidden=true href=#vertical-pod-autoscaler-vpa>#</a></h2><p>Consta de tres componentes:</p><ul><li><p><a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/recommender/README.md>Recommender</a>: es el componente principal del VPA, cuya misión es generar recomendaciones de asignación de CPU y memoria basados en el histórico y consumo actual de CPU y memoria.
<a href=/2023/kubernetes/vertical-pod-autoscaler-recommender.png><img alt="Diagrama funcionamiento Recommender" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-recommender.png></a></p></li><li><p><a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/updater/README.md>Updater</a>: decide qué Pods deben ser reiniciados basándose en los datos del <code>recommender</code>. Si se debe ajustar la CPU y memoria de un pod, intentará terminar su ejecución (revisando <a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/>Pod Disruption Budget (PDB)</a>) - evento <code>EvictedByVPA</code> . La actualización de la asignación de los recursos es realizada por el <code>Admission Controller</code>.
<a href=/2023/kubernetes/vertical-pod-autoscaler-updater.png><img alt="Diagrama funcionamiento Updater" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-updater.png></a></p></li><li><p><a href=https://github.com/kubernetes/autoscaler/blob/master/vertical-pod-autoscaler/pkg/admission-controller/README.md>Admission Controller</a>: por cada Pod creado en el clúster, comprueba si debe realizar una actualización de los recursos asignados basándose en la configuración y recomendaciones del VPA (si la hay).</p></li></ul><p><a href=/2023/kubernetes/vertical-pod-autoscaler-all.png><img alt="Diagrama funcionamiento Admission Controller" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-all.png></a></p><h3 id=objecto-vpa-vertical-pod-autoscaler>Objecto VPA (Vertical Pod Autoscaler)<a hidden class=anchor aria-hidden=true href=#objecto-vpa-vertical-pod-autoscaler>#</a></h3><p>Para poder definir el comportamiento del VPA para nuestros Pods es necesario crear un recurso de tipo <code>VerticalPodAutoscaler</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;autoscaling.k8s.io/v1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VerticalPodAutoscaler</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster-vpa</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;apps/v1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>updatePolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>updateMode</span>: <span style=color:#e6db74>&#34;Auto&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resourcePolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerPolicies</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>containerName</span>: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>minAllowed</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>50Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>maxAllowed</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>500Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>controlledResources</span>: [<span style=color:#e6db74>&#34;cpu&#34;</span>, <span style=color:#e6db74>&#34;memory&#34;</span>]
</span></span></code></pre></div><ul><li><strong>targetRef</strong>: Indicaremos el recurso sobre el que el VPA actuará:<ul><li><strong>kind</strong>: tipo de controlador (ej.: deployment o daemonset) que controla los Pods a monitorizar y actualizar los recursos asignados a los Pods</li><li><strong>name</strong>: nombre del recurso</li></ul></li><li><strong>containerPolicies</strong>:<ul><li><strong>containerName</strong>: Nombre del contenedor (podemos usar <code>*</code> para aplicar la configuración a todos los containers del pod)</li><li><strong>minAllowed</strong>: Los recursos mínimos que el VPA puede asignar al container (CPU y/o memoria)</li><li><strong>maxAllowed</strong>: Los recursos máximos que el VPA puede asignar al container (CPU y/o memoria)</li><li><strong>controlledResources</strong>: El tipo de recurso o recusos a monitorizar (CPU y/o memoria)</li></ul></li><li><strong>updatePolicy</strong>: VPA ofrece cuatro modos para aplicar las recomendaciones de asignación de CPU y memoria:<ul><li><strong>Off</strong>: El <code>recommender</code> calcula las recomendaciones de asignación de recursos pero el <code>updater</code> nunca reinicia los Pods para aplicar los cambios (modo &ldquo;dry-run&rdquo;)</li><li><strong>Initial</strong>: Solo se se asignan las recomendaciones cuando se crea el pod, no se realiza ningún cambio durante el ciclo de vida del mismo</li><li><strong>Recreate</strong>: El VPA puede asignar las recomendaciones cuando se crea el Pod y durante su ciclo de vida</li><li><strong>Auto</strong>: Actualmente equivale a la opción <code>Recreate</code> ya que es el unico metodo de actualización disponible (valor por defecto)</li></ul></li></ul><h3 id=instalación>Instalación<a hidden class=anchor aria-hidden=true href=#instalación>#</a></h3><p>A día de hoy, VPA no está incluido como un componente en Kubernetes por lo que es necesario instalarlo desde su repositorio.</p><blockquote><p>&#9888;&#xfe0f; <strong>Revisa las instrucciones de instalación, es posible que hayan cambiado.</strong></p></blockquote><h4 id=minikube>Minikube<a hidden class=anchor aria-hidden=true href=#minikube>#</a></h4><p>Desplegar los componentes del VPA es muy sencillo:</p><ol><li>Clonaremos el repositorio <a href=https://github.com/kubernetes/autoscaler/tree/master>https://github.com/kubernetes/autoscaler/tree/master</a></li><li>Ejecutamos el comando <code>./hack/vpa-up.sh</code> desde la carpeta <code>vertical-pod-autoscaler</code></li></ol><h4 id=azure-azure-kubernetes-service>Azure (Azure Kubernetes Service)<a hidden class=anchor aria-hidden=true href=#azure-azure-kubernetes-service>#</a></h4><p>Azure permite habilitar/deshabilitar Vertical Pod Autoscaler en un clúster AKS. Para ello, debemos registrar el &ldquo;feature flag&rdquo; <code>AKS-VPAPreview</code> en nuestra subscripción utilizando el siguiente comando: <code>az feature register --namespace "Microsoft.ContainerService" --name "AKS-VPAPreview"</code>.</p><p>Una vez registrado, podemos utilizar Terraform, Bicep o az cli para desplegar automáticamente VPA en nuestro clúster.</p><p>Si estás utilizando Terraform, asegúrate de usar al menos la <a href=https://github.com/hashicorp/terraform-provider-azurerm/blob/v3.47.0/CHANGELOG.md>versión 3.47 de terraform-provider-azurerm</a> y agrega el siguiente bloque de código al recurso <code>azurerm_kubernetes_cluster</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span>  <span style=color:#a6e22e>workload_autoscaler_profile</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>vertical_pod_autoscaler_enabled</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><blockquote><p>Puedes utilizar el código de Terraform de este <a href=https://github.com/fjvela/poc-k8s/tree/main/terraform/azure-aks-vpa>repositorio</a> para desplegar un clúster AKS con el componente VPA desplegado. Para facilitar la prueba, el clúster es público.</p></blockquote><blockquote><p>&#9888;&#xfe0f; ¡No utilices este código para desplegar un clúster en un entorno productivo! Recuerda borrarlo una vez finalizadas las pruebas para evitar problemas y/o costes innecesarios.</p></blockquote><p>Si utilizas Bicep, puedes encontrar cómo habilitarlo en el siguiente enlace: <a href="https://learn.microsoft.com/en-us/azure/templates/microsoft.containerservice/managedclusters?pivots=deployment-language-bicep#managedclusterworkloadautoscalerprofileverticalpodau">https://learn.microsoft.com/en-us/azure/templates/microsoft.containerservice/managedclusters?pivots=deployment-language-bicep#managedclusterworkloadautoscalerprofileverticalpodau</a></p><p>También puedes utilizar la línea de comandos <code>az</code>, puedes consultar los comandos necesarios en el enlace: <a href=https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#deploy-upgrade-or-disable-vpa-on-a-cluster>https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#deploy-upgrade-or-disable-vpa-on-a-cluster</a></p><p>Ten en cuenta que la versión desplegada por Azure es una versión del Vertical Pod Autoscaler modificada por Microsoft, su funcionamiento y rendimiento deberían ser mejores y optimizados para trabajar en un clúster AKS.</p><h4 id=comprobación-de-la-instalación>Comprobación de la instalación<a hidden class=anchor aria-hidden=true href=#comprobación-de-la-instalación>#</a></h4><p>Los componentes se instalan en el namespace <code>kube-system</code>, comprobamos que los tres componentes están arrancados y funcionan sin problema (<code>kubectl get pods -l 'app in( vpa-admission-controller, vpa-recommender, vpa-updater)' -n kube-system)</code>):</p><p><a href=/2023/kubernetes/vertical-pod-autoscaler-vpa-instalacion-ok.png><img alt="Muestra los 3 Pods ejecutándose en el cluster" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-vpa-instalacion-ok.png></a></p><h3 id=funcionamiento>Funcionamiento<a hidden class=anchor aria-hidden=true href=#funcionamiento>#</a></h3><p>El siguiente paso es ejecutar un ejemplo para poder revisar el funcionamiento del VPA en el clúster, en el propio repositorio podemos encontrar el siguiente ejemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;autoscaling.k8s.io/v1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VerticalPodAutoscaler</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster-vpa</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;apps/v1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>updatePolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>updateMode</span>: <span style=color:#e6db74>&#34;Auto&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resourcePolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerPolicies</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>containerName</span>: <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>minAllowed</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>50Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>maxAllowed</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>500Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>controlledResources</span>: [<span style=color:#e6db74>&#34;cpu&#34;</span>, <span style=color:#e6db74>&#34;memory&#34;</span>]
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>securityContext</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsNonRoot</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>runAsUser</span>: <span style=color:#ae81ff>65534</span> <span style=color:#75715e># nobody</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hamster</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.k8s.io/ubuntu-slim:0.1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>50Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>]
</span></span><span style=display:flex><span>          <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;-c&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;while true; do timeout 0.5s yes &gt;/dev/null; sleep 0.5s; done&#34;</span>
</span></span></code></pre></div><p>En el ejemplo, podemos ver la definición de un objeto VPA, el cual actuará sobre el <code>Deployment</code> <code>hamster</code> y monitorizará tanto la memoria como la CPU consumida por los pods del deployment. Los recursos mínimos y máximos que podrá asignar son los siguientes:</p><table><thead><tr><th></th><th>Mínimo</th><th>Máximo</th></tr></thead><tbody><tr><td>CPU</td><td>100m</td><td>1</td></tr><tr><td>Memoria</td><td>50Mi</td><td>500Mi</td></tr></tbody></table><h4 id=logs-recommender>Logs recommender<a hidden class=anchor aria-hidden=true href=#logs-recommender>#</a></h4><p>Cada 1 minuto, el <code>recommender</code> comprueba las métricas y calcula si es necesario realizar una actualización de los recursos:</p><pre tabindex=0><code>I0515 16:59:00.167961       1 recommender.go:168] Recommender Run
I0515 16:59:00.168058       1 cluster_feeder.go:355] Start selecting the vpaCRDs.
I0515 16:59:00.168066       1 cluster_feeder.go:390] Fetched 1 VPAs.
I0515 16:59:00.168093       1 cluster_feeder.go:400] Using selector app=hamster for VPA default/hamster-vpa
I0515 16:59:00.174398       1 metrics_client.go:77] 11 podMetrics retrieved for all namespaces
I0515 16:59:00.174452       1 cluster_feeder.go:478] ClusterSpec fed with #22 ContainerUsageSamples for #11 containers. Dropped #0 samples.
I0515 16:59:00.174460       1 recommender.go:178] ClusterState is tracking 13 PodStates and 1 VPAs
I0515 16:59:00.194835       1 checkpoint_writer.go:114] Saved VPA default/hamster-vpa checkpoint for hamster
I0515 16:59:00.194867       1 cluster.go:362] Garbage collection of AggregateCollectionStates triggered
I0515 16:59:00.194890       1 recommender.go:188] ClusterState is tracking 12 aggregated container states
</code></pre><p>Cuando se genera una recomendación, se puede consultar en el objeto VPA. Para ello ejecutamos el comando <code>kubectl get vpa -o=jsonpath='{.items[0].status}' | jq</code> :</p><p><a href=/2023/kubernetes/vertical-pod-autoscaler-vpa-recomendation-saved.png><img alt="VPA recomendación aumento recursos" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-vpa-recomendation-saved.png></a></p><h4 id=logs-updater>Logs updater<a hidden class=anchor aria-hidden=true href=#logs-updater>#</a></h4><p>En el caso de que haya una recomendación por parte del <code>recommender</code>, el <code>updater</code> eliminará los Pods asociados al deployment (razón: <code>EvictedByVPA</code> ). Este proceso también se ejecuta cada 1 minuto.</p><pre tabindex=0><code>I0515 17:11:06.957414       1 api.go:92] Initial VPA synced successfully
I0515 17:11:06.957601       1 reflector.go:221] Starting reflector *v1.Pod (1h0m0s) from k8s.io/autoscaler/vertical-pod-autoscaler/pkg/updater/logic/updater.go:289
I0515 17:11:06.957675       1 reflector.go:257] Listing and watching *v1.Pod from k8s.io/autoscaler/vertical-pod-autoscaler/pkg/updater/logic/updater.go:289
I0515 17:12:06.959731       1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-mc9f5 with priority 8.870000000000001
I0515 17:12:06.959861       1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-jqblb with priority 8.870000000000001
I0515 17:12:06.959890       1 updater.go:215] evicting pod hamster-65cd4dd797-mc9f5
I0515 17:12:06.976619       1 event.go:285] Event(v1.ObjectReference{Kind:&#34;Pod&#34;, Namespace:&#34;default&#34;, Name:&#34;hamster-65cd4dd797-mc9f5&#34;, UID:&#34;d22d508d-26f4-4d89-b371-edd744018f57&#34;, APIVersion:&#34;v1&#34;, ResourceVersion:&#34;118847&#34;, FieldPath:&#34;&#34;}): type: &#39;Normal&#39; reason: &#39;EvictedByVPA&#39; Pod was evicted by VPA Updater to apply resource recommendation.
I0515 17:13:06.951468       1 update_priority_calculator.go:143] pod accepted for update default/hamster-65cd4dd797-jqblb with priority 8.870000000000001
I0515 17:13:06.951508       1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-jxgtj, request within recommended range
I0515 17:13:06.951520       1 updater.go:215] evicting pod hamster-65cd4dd797-jqblb
I0515 17:13:06.969737       1 event.go:285] Event(v1.ObjectReference{Kind:&#34;Pod&#34;, Namespace:&#34;default&#34;, Name:&#34;hamster-65cd4dd797-jqblb&#34;, UID:&#34;c7de721e-cc47-4906-8c15-10b4e4725b82&#34;, APIVersion:&#34;v1&#34;, ResourceVersion:&#34;118845&#34;, FieldPath:&#34;&#34;}): type: &#39;Normal&#39; reason: &#39;EvictedByVPA&#39; Pod was evicted by VPA Updater to apply resource recommendation.
I0515 17:14:06.949563       1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-jxgtj, request within recommended range
I0515 17:14:06.949598       1 update_priority_calculator.go:129] not updating a short-lived pod default/hamster-65cd4dd797-qj6tg, request within recommended range
</code></pre><p>Con el comando <code>kubectl get event --field-selector reason=EvictedByVPA</code> podemos comprobar los eventos de borrado de los Pods para poder asignarles los nuevos recursos:</p><p><a href=/2023/kubernetes/vertical-pod-autoscaler-vpa-updated-events.png><img alt="Eventos Kubernetes borrado Pods" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-vpa-updated-events.png></a></p><h4 id=logs-admission-controller>Logs Admission Controller<a hidden class=anchor aria-hidden=true href=#logs-admission-controller>#</a></h4><p>Todas las solicitudes de creación de un nuevo Pod son enviadas a los <code>admission controller</code> desplegados en el clúster. En nuestro caso, comprobará si es necesario actualizar los recursos asignados al pod:</p><pre tabindex=0><code>I0515 17:11:27.569672       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default    0 0001-01-01 00:00:00 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000596d20 0xc00068cd80 []} {&lt;nil&gt; []}}
I0515 17:11:27.598513       1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default    0 0001-01-01 00:00:00 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc000320d27 0xc000320d28}] [] [{kube-controller-manager Update v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:generateName&#34;:{},&#34;f:labels&#34;:{&#34;.&#34;:{},&#34;f:app&#34;:{},&#34;f:pod-template-hash&#34;:{}},&#34;f:ownerReferences&#34;:{&#34;.&#34;:{},&#34;k:{\&#34;uid\&#34;:\&#34;bf57314a-36a6-48fd-a297-269d21f364a4\&#34;}&#34;:{}}},&#34;f:spec&#34;:{&#34;f:containers&#34;:{&#34;k:{\&#34;name\&#34;:\&#34;hamster\&#34;}&#34;:{&#34;.&#34;:{},&#34;f:args&#34;:{},&#34;f:command&#34;:{},&#34;f:image&#34;:{},&#34;f:imagePullPolicy&#34;:{},&#34;f:name&#34;:{},&#34;f:resources&#34;:{&#34;.&#34;:{},&#34;f:requests&#34;:{&#34;.&#34;:{},&#34;f:cpu&#34;:{},&#34;f:memory&#34;:{}}},&#34;f:terminationMessagePath&#34;:{},&#34;f:terminationMessagePolicy&#34;:{}}},&#34;f:dnsPolicy&#34;:{},&#34;f:enableServiceLinks&#34;:{},&#34;f:restartPolicy&#34;:{},&#34;f:schedulerName&#34;:{},&#34;f:securityContext&#34;:{&#34;.&#34;:{},&#34;f:runAsNonRoot&#34;:{},&#34;f:runAsUser&#34;:{}},&#34;f:terminationGracePeriodSeconds&#34;:{}}} }]}
I0515 17:11:27.598984       1 matcher.go:68] Let&#39;s choose from 1 configs for pod default/hamster-65cd4dd797-%
I0515 17:11:27.600342       1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%.
I0515 17:11:27.600588       1 recommendation_provider.go:57] no matching recommendation found for container hamster, skipping
I0515 17:11:27.600671       1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: } {add /metadata/annotations/vpaObservedContainers hamster}]
I0515 17:11:27.609234       1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default    0 0001-01-01 00:00:00 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc00080c927 0xc00080c928}] [] [{kube-controller-manager Update v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:generateName&#34;:{},&#34;f:labels&#34;:{&#34;.&#34;:{},&#34;f:app&#34;:{},&#34;f:pod-template-hash&#34;:{}},&#34;f:ownerReferences&#34;:{&#34;.&#34;:{},&#34;k:{\&#34;uid\&#34;:\&#34;bf57314a-36a6-48fd-a297-269d21f364a4\&#34;}&#34;:{}}},&#34;f:spec&#34;:{&#34;f:containers&#34;:{&#34;k:{\&#34;name\&#34;:\&#34;hamster\&#34;}&#34;:{&#34;.&#34;:{},&#34;f:args&#34;:{},&#34;f:command&#34;:{},&#34;f:image&#34;:{},&#34;f:imagePullPolicy&#34;:{},&#34;f:name&#34;:{},&#34;f:resources&#34;:{&#34;.&#34;:{},&#34;f:requests&#34;:{&#34;.&#34;:{},&#34;f:cpu&#34;:{},&#34;f:memory&#34;:{}}},&#34;f:terminationMessagePath&#34;:{},&#34;f:terminationMessagePolicy&#34;:{}}},&#34;f:dnsPolicy&#34;:{},&#34;f:enableServiceLinks&#34;:{},&#34;f:restartPolicy&#34;:{},&#34;f:schedulerName&#34;:{},&#34;f:securityContext&#34;:{&#34;.&#34;:{},&#34;f:runAsNonRoot&#34;:{},&#34;f:runAsUser&#34;:{}},&#34;f:terminationGracePeriodSeconds&#34;:{}}} }]}
I0515 17:11:27.609377       1 matcher.go:68] Let&#39;s choose from 1 configs for pod default/hamster-65cd4dd797-%
I0515 17:11:27.609391       1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%.
I0515 17:11:27.609399       1 recommendation_provider.go:57] no matching recommendation found for container hamster, skipping
I0515 17:11:27.609444       1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: } {add /metadata/annotations/vpaObservedContainers hamster}]
I0515 17:12:00.170779       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 118818 1 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:12:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000411b90 0xc00088c378 []} {0xc00088c450 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:12:06.982108       1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default    0 0001-01-01 00:00:00 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc0008a2157 0xc0008a2158}] [] [{kube-controller-manager Update v1 2023-05-15 17:12:06 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:generateName&#34;:{},&#34;f:labels&#34;:{&#34;.&#34;:{},&#34;f:app&#34;:{},&#34;f:pod-template-hash&#34;:{}},&#34;f:ownerReferences&#34;:{&#34;.&#34;:{},&#34;k:{\&#34;uid\&#34;:\&#34;bf57314a-36a6-48fd-a297-269d21f364a4\&#34;}&#34;:{}}},&#34;f:spec&#34;:{&#34;f:containers&#34;:{&#34;k:{\&#34;name\&#34;:\&#34;hamster\&#34;}&#34;:{&#34;.&#34;:{},&#34;f:args&#34;:{},&#34;f:command&#34;:{},&#34;f:image&#34;:{},&#34;f:imagePullPolicy&#34;:{},&#34;f:name&#34;:{},&#34;f:resources&#34;:{&#34;.&#34;:{},&#34;f:requests&#34;:{&#34;.&#34;:{},&#34;f:cpu&#34;:{},&#34;f:memory&#34;:{}}},&#34;f:terminationMessagePath&#34;:{},&#34;f:terminationMessagePolicy&#34;:{}}},&#34;f:dnsPolicy&#34;:{},&#34;f:enableServiceLinks&#34;:{},&#34;f:restartPolicy&#34;:{},&#34;f:schedulerName&#34;:{},&#34;f:securityContext&#34;:{&#34;.&#34;:{},&#34;f:runAsNonRoot&#34;:{},&#34;f:runAsUser&#34;:{}},&#34;f:terminationGracePeriodSeconds&#34;:{}}} }]}
I0515 17:12:06.982216       1 matcher.go:68] Let&#39;s choose from 1 configs for pod default/hamster-65cd4dd797-%
I0515 17:12:06.982226       1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%.
I0515 17:12:06.983687       1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /spec/containers/0/resources/requests/cpu 587m} {add /spec/containers/0/resources/requests/memory 262144k} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: cpu request, memory request} {add /metadata/annotations/vpaObservedContainers hamster}]
I0515 17:13:00.163171       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 118878 2 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:13:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc0007366f0 0xc00080e708 []} {0xc00080e7e0 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:13:06.976062       1 handler.go:79] Admitting pod {hamster-65cd4dd797-% hamster-65cd4dd797- default    0 0001-01-01 00:00:00 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[app:hamster pod-template-hash:65cd4dd797] map[] [{apps/v1 ReplicaSet hamster-65cd4dd797 bf57314a-36a6-48fd-a297-269d21f364a4 0xc0008a2427 0xc0008a2428}] [] [{kube-controller-manager Update v1 2023-05-15 17:13:06 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:generateName&#34;:{},&#34;f:labels&#34;:{&#34;.&#34;:{},&#34;f:app&#34;:{},&#34;f:pod-template-hash&#34;:{}},&#34;f:ownerReferences&#34;:{&#34;.&#34;:{},&#34;k:{\&#34;uid\&#34;:\&#34;bf57314a-36a6-48fd-a297-269d21f364a4\&#34;}&#34;:{}}},&#34;f:spec&#34;:{&#34;f:containers&#34;:{&#34;k:{\&#34;name\&#34;:\&#34;hamster\&#34;}&#34;:{&#34;.&#34;:{},&#34;f:args&#34;:{},&#34;f:command&#34;:{},&#34;f:image&#34;:{},&#34;f:imagePullPolicy&#34;:{},&#34;f:name&#34;:{},&#34;f:resources&#34;:{&#34;.&#34;:{},&#34;f:requests&#34;:{&#34;.&#34;:{},&#34;f:cpu&#34;:{},&#34;f:memory&#34;:{}}},&#34;f:terminationMessagePath&#34;:{},&#34;f:terminationMessagePolicy&#34;:{}}},&#34;f:dnsPolicy&#34;:{},&#34;f:enableServiceLinks&#34;:{},&#34;f:restartPolicy&#34;:{},&#34;f:schedulerName&#34;:{},&#34;f:securityContext&#34;:{&#34;.&#34;:{},&#34;f:runAsNonRoot&#34;:{},&#34;f:runAsUser&#34;:{}},&#34;f:terminationGracePeriodSeconds&#34;:{}}} }]}
I0515 17:13:06.976162       1 matcher.go:68] Let&#39;s choose from 1 configs for pod default/hamster-65cd4dd797-%
I0515 17:13:06.976171       1 recommendation_provider.go:90] updating requirements for pod hamster-65cd4dd797-%.
I0515 17:13:06.976209       1 server.go:112] Sending patches: [{add /metadata/annotations map[]} {add /spec/containers/0/resources/requests/cpu 587m} {add /spec/containers/0/resources/requests/memory 262144k} {add /metadata/annotations/vpaUpdates Pod resources updated by hamster-vpa: container 0: cpu request, memory request} {add /metadata/annotations/vpaObservedContainers hamster}]
I0515 17:14:00.160455       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 118956 3 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:14:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc00042ff40 0xc0006a0510 []} {0xc0006a05e8 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:15:00.165045       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 119037 4 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:15:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc00037b320 0xc00088c750 []} {0xc00088c828 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:16:00.159714       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 119092 5 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:16:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc000597e10 0xc0005610b0 []} {0xc000561188 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:16:33.741189       1 reflector.go:559] k8s.io/autoscaler/vertical-pod-autoscaler/pkg/target/fetcher.go:94: Watch close - *v1.DaemonSet total 6 items received
I0515 17:16:43.942408       1 reflector.go:559] k8s.io/client-go/informers/factory.go:134: Watch close - *v1.LimitRange total 7 items received
I0515 17:17:00.163545       1 handler.go:91] Processing vpa: &amp;{{VerticalPodAutoscaler autoscaling.k8s.io/v1} {hamster-vpa  default  49f80082-26b4-4511-b096-b2e5a477b34d 119147 6 2023-05-15 17:11:27 +0000 UTC &lt;nil&gt; &lt;nil&gt; map[] map[kubectl.kubernetes.io/last-applied-configuration:{&#34;apiVersion&#34;:&#34;autoscaling.k8s.io/v1&#34;,&#34;kind&#34;:&#34;VerticalPodAutoscaler&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;hamster-vpa&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;resourcePolicy&#34;:{&#34;containerPolicies&#34;:[{&#34;containerName&#34;:&#34;*&#34;,&#34;controlledResources&#34;:[&#34;cpu&#34;,&#34;memory&#34;],&#34;maxAllowed&#34;:{&#34;cpu&#34;:1,&#34;memory&#34;:&#34;500Mi&#34;},&#34;minAllowed&#34;:{&#34;cpu&#34;:&#34;100m&#34;,&#34;memory&#34;:&#34;50Mi&#34;}}]},&#34;targetRef&#34;:{&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,&#34;name&#34;:&#34;hamster&#34;},&#34;updatePolicy&#34;:{&#34;updateMode&#34;:&#34;Auto&#34;}}}
] [] [] [{kubectl-client-side-apply Update autoscaling.k8s.io/v1 2023-05-15 17:11:27 +0000 UTC FieldsV1 {&#34;f:metadata&#34;:{&#34;f:annotations&#34;:{&#34;.&#34;:{},&#34;f:kubectl.kubernetes.io/last-applied-configuration&#34;:{}}},&#34;f:spec&#34;:{&#34;.&#34;:{},&#34;f:resourcePolicy&#34;:{&#34;.&#34;:{},&#34;f:containerPolicies&#34;:{}},&#34;f:targetRef&#34;:{},&#34;f:updatePolicy&#34;:{&#34;.&#34;:{},&#34;f:updateMode&#34;:{}}}} } {recommender Update autoscaling.k8s.io/v1 2023-05-15 17:17:00 +0000 UTC FieldsV1 {&#34;f:status&#34;:{&#34;.&#34;:{},&#34;f:conditions&#34;:{},&#34;f:recommendation&#34;:{&#34;.&#34;:{},&#34;f:containerRecommendations&#34;:{}}}} }]} {&amp;CrossVersionObjectReference{Kind:Deployment,Name:hamster,APIVersion:apps/v1,} 0xc0004112c0 0xc000560390 []} {0xc000560468 [{RecommendationProvided True 2023-05-15 17:12:00 +0000 UTC  }]}}
I0515 17:17:00.846076       1 reflector.go:559] k8s.io/autoscaler/vertical-pod-autoscaler/pkg/target/fetcher.go:94: Watch close - *v1.Deployment total 20 items received
</code></pre><p>Comprobamos las anotaciones de los Pods con el comando <code>kubectl get pods -o=jsonpath='{.items[0].metadata.annotations}' | jq</code>:</p><p><a href=/2023/kubernetes/vertical-pod-autoscaler-pod-annotations.png><img alt="Pod annotations tras asignar los nuevos recursos" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-pod-annotations.png></a></p><p>Comprobamos los nuevos recursos asignados con el comando <code>kubectl get pods -o=jsonpath='{.items[0].spec.containers[0].resources}' | jq</code>:</p><p><a href=/2023/kubernetes/vertical-pod-autoscaler-pod-resources.png><img alt="Recursos asignados tras asignar los nuevos recursos" loading=lazy src=/2023/kubernetes/vertical-pod-autoscaler-pod-resources.png></a></p><h3 id=limitaciones>Limitaciones<a hidden class=anchor aria-hidden=true href=#limitaciones>#</a></h3><p>Actualmente el estado del componente se encuentra en estado beta y tiene algunas limitaciones conocidas:</p><ul><li>Cada vez que se actualizan los recursos, los Pods son recreados</li><li>VPA no garantiza que una vez eliminados los Pods estos se puedan recrear (ej. no hay espacio suficiente en el nodepool)</li><li>La escalabilidad vertical no debe utilizarse junto con la escalabilidad horizontal</li><li>Antes de utilizar VPA, debemos comprobar los Admission controllers existentes</li></ul><h3 id=conclusión>Conclusión<a hidden class=anchor aria-hidden=true href=#conclusión>#</a></h3><p>No en todos los casos de uso podemos hacer uso del Horizontal Pod Autoscaler (HPA) para escalar nuestras aplicaciones en clúster Kubernetes, aunque actualmente la escalabilidad vertical disponible en Kubernetes se encuentra en fase beta y tiene algunas limitaciones, creo que en el futuro se hará un mayor uso de ella, ya que combinada con una buena monitorización, una buena configuración del clúster autoscaler y un buen ajuste del tamaño de los nodepools del clúster podremos optimizar de manera muy efectiva los recursos hardware y a su vez los costes de los mismos.</p><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ul><li><a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler>https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler</a></li><li><a href=https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler>https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler</a></li><li><a href=https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#register-the-aks-vpapreview-feature-flag>https://learn.microsoft.com/en-us/azure/aks/vertical-pod-autoscaler#register-the-aks-vpapreview-feature-flag</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.javivela.dev/tags/kubernetes/>Kubernetes</a></li><li><a href=https://blog.javivela.dev/tags/k8s/>K8S</a></li><li><a href=https://blog.javivela.dev/tags/autoscaler/>Autoscaler</a></li></ul><nav class=paginav><a class=prev href=https://blog.javivela.dev/posts/2024/dotnet/desarrolla-aplicaciones-distribuida-dotnet-aspire/><span class=title>« Anterior</span><br><span>Desarrolla aplicaciones distribuidas con .NET Aspire</span>
</a><a class=next href=https://blog.javivela.dev/posts/2023/dotnet/csharp-12-net-8-preview-3/><span class=title>Siguiente »</span><br><span>Novedades en C# 12 (.NET 8 preview 3)</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on x" href="https://x.com/intent/tweet/?text=Kubernetes%20-%20Vertical%20Pod%20Autoscaler&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f&amp;hashtags=kubernetes%2ck8s%2cautoscaler"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f&amp;title=Kubernetes%20-%20Vertical%20Pod%20Autoscaler&amp;summary=Kubernetes%20-%20Vertical%20Pod%20Autoscaler&amp;source=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f&title=Kubernetes%20-%20Vertical%20Pod%20Autoscaler"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on whatsapp" href="https://api.whatsapp.com/send?text=Kubernetes%20-%20Vertical%20Pod%20Autoscaler%20-%20https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on telegram" href="https://telegram.me/share/url?text=Kubernetes%20-%20Vertical%20Pod%20Autoscaler&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Kubernetes - Vertical Pod Autoscaler on ycombinator" href="https://news.ycombinator.com/submitlink?t=Kubernetes%20-%20Vertical%20Pod%20Autoscaler&u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2023%2fkubernetes%2fvertical-pod-autoscaler%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.javivela.dev/>Javi Vela Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> &
<a href=https://librecounter.org/ rel=noopener target=_blank>LibreCounter</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><img src=https://librecounter.org/counter.svg referrerpolicy=unsafe-url width=0>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copiar";function s(){t.innerHTML="¡copiado!",setTimeout(()=>{t.innerHTML="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>