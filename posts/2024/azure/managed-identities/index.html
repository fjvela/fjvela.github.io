<!doctype html><html lang=es dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Azure Managed Identities | Javi Vela Blog</title><meta name=keywords content="Azure,Security,Microsoft Entra,Identity"><meta name=description content="Managed Identities simplifican la gestión de credenciales y la autenticación en Azure. Las aplicaciones pueden acceder de forma segura a otros recursos de Azure sin necesidad de gestionar credenciales de forma manual."><meta name=author content="Javi Vela"><link rel=canonical href=https://blog.javivela.dev/posts/2024/azure/managed-identities/><meta name=google-site-verification content="Z9k5TW79n5H64zWLwEcNkbNITNDDepKoE2udZjirxXM"><meta name=msvalidate.01 content="6A293DF736526A40A24D911811A73F7D"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.javivela.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.javivela.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.javivela.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.javivela.dev/apple-touch-icon.png><link rel=mask-icon href=https://blog.javivela.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=es href=https://blog.javivela.dev/posts/2024/azure/managed-identities/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.javivela.dev/posts/2024/azure/managed-identities/"><meta property="og:site_name" content="Javi Vela Blog"><meta property="og:title" content="Azure Managed Identities"><meta property="og:description" content="Managed Identities simplifican la gestión de credenciales y la autenticación en Azure. Las aplicaciones pueden acceder de forma segura a otros recursos de Azure sin necesidad de gestionar credenciales de forma manual."><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-03T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-03T00:00:00+00:00"><meta property="article:tag" content="Azure"><meta property="article:tag" content="Security"><meta property="article:tag" content="Microsoft Entra"><meta property="article:tag" content="Identity"><meta property="og:image" content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:title content="Azure Managed Identities"><meta name=twitter:description content="Managed Identities simplifican la gestión de credenciales y la autenticación en Azure. Las aplicaciones pueden acceder de forma segura a otros recursos de Azure sin necesidad de gestionar credenciales de forma manual."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.javivela.dev/posts/"},{"@type":"ListItem","position":2,"name":"Azure Managed Identities","item":"https://blog.javivela.dev/posts/2024/azure/managed-identities/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Azure Managed Identities","name":"Azure Managed Identities","description":"Managed Identities simplifican la gestión de credenciales y la autenticación en Azure. Las aplicaciones pueden acceder de forma segura a otros recursos de Azure sin necesidad de gestionar credenciales de forma manual.","keywords":["Azure","Security","Microsoft Entra","Identity"],"articleBody":" Puedes encontrar el código fuente del post en el siguiente enlace: https://github.com/fjvela/blog-managed-identities\nIntroducción Uno de los grandes retos que tenemos hoy en día es gestionar la información sensible (credenciales, certificados, …) que nuestras aplicaciones necesitan.\nAzure proporciona Managed Identities para simplificar la autenticación necesaria para acceder a los recursos desplegados en Azure como Azure Key Vault. Puedes comprobar la lista de servicios que soportan la autenticación a través de Managed Identities en el siguiente enlace: https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/managed-identities-status\nLa utilización de Managed Identities tiene algunas ventajas:\nNo es necesario utilizar y/o gestionar credenciales Permite autenticarnos con cualquier otra aplicación (incluyendo nuestras propias aplicaciones) No tiene un coste extra Tipos de Managed Identities Existen dos tipos de Managed Identities:\nSystem managed identities: Son creadas automáticamente por Azure cuando se crean algunos servicios como máquinas virtuales: Solo se puede utilizar por el servicio que la ha creado Su ciclo de vida está asociado al ciclo de vida del recurso que lo ha creado (si borras el recurso, se borra la Managed Identity) Automáticamente se crea un Service Principal en Microsoft Entra ID (directorio activo) Debemos autorizar a qué servicios pueden acceder a la Managed Identity User managed identities: Podemos crear un Managed Identity y asignársela a más de una aplicación: Podemos utilizarla en una o varias aplicaciones Debemos autorizar a qué servicios pueden acceder las aplicaciones que usen la Managed Identity creada Automáticamente se crea un Service Principal en Microsoft Entra ID (directorio activo), su ciclo de vida no está asociado al ciclo de vida de la aplicación que lo utiliza ¿Cómo funciona? Antes de explicar como funciona el proceso de creación y funcionamiento de una managed identity, debemos conocer qué es Azure Instance Metadata Service identity (IMSI):\nEs un servicio REST interno disponible en la dirección IP: 169.254.169.254 Proporciona información sobre las instancias de VM en ejecución: Sistema operativo, mantenimientos programados, … También proporciona tokens de autenticación que obtiene de Microsoft Entra ID Azure Resource Manager crea un service principal en Microsoft Entra ID asociado a la Managed Identity creada A continuación Azure Resource Manager, actualiza Azure Instance Metadata Service identity (IMSI) proporcionando el ID el service principal y los certificados creados por Microsoft Entra ID. Más tarde serán necesarios para poder autenticarse contra Microsoft Entra ID En este paso, Azure Resource Manager habilita los permisos necesarios para acceder a otros recursos de Azure (Azure RBAC). Por ejemplo, asignar el rol Key Vault Secrets User para poder leer secretos de un Azure Key Vault Cuando nuestra aplicación necesita acceder al recurso, se comunica con el IMSI, el cual solicita un token de autenticación a Microsoft Entra ID (utilizando el service principal y certificados creados en el paso 2) que será utilizado por la aplicación para poder acceder a otros recursos desplegados en Azure. Habilitar una Managed Identity en Azure Como hemos comentado, exiten dos tipos de Managed Identites: System managed identities y User managed identities. Vamos a ver como crear y habilitarlas en Azure.\nUna vez creada la managed identity, debemos asignar los permisos correspondientes de acceso.\nSystem Managed Identity Para crear un System Managed Identity asociado a un recurso de Azure tan solo debemos seleccionarlo desde el portal y en el menu “Identity”, habilitarlo y guardar los cambios realizados.\nUser Managed Identity Desde el apartado “Managed Identities” podemos crear User Managed Identites, una vez completados los datos requeridos debemos asignar la managed identity al recurso o recursos que harán uso de ella.\nComo acceder a un recurso en Azure utilizando una Managed Identity utilizando .NET Podemos hacer uso de las Managed Identities creadas en Azure a través de los diferentes SDKs disponibles o implementando el código necesario para poder interactuar con el API REST proporcionado por la IMSI y así obtener los tokens de autenticación para acceder a otros recursos de Azure.\nVamos a describir cómo podemos acceder a un Azure Key Vault utilizando código .NET y la librería Azure.Identity:\nCrea una proyecto .NET, en este caso hemos creado un proyecto tipo Azure Functions para facilitar su despliegue en Azure Añade la referencia a la librería Azure.Identity dotnet add package Azure.Identity Azure.Identity proporciona varias clases que encapsulan la lógica necesaria para poder obtener un token de autenticación de Microsoft Entra ID haciendo uso de la Managed Identity configurada a través de la IMSI:\nDefaultAzureCredential: Intenta realizar la autenticación a través de diferentes mecanismos hasta que consigue conectarse con uno de ellos. var credential = new DefaultAzureCredential(); var client = new SecretClient(new Uri(\"https://mykv.vault.azure.net/\"), credential); ChainedTokenCredential: Intenta realizar la autenticación a través de la Managed Identity. Si no lo consigue, intenta conectarse utilizando a través de Azure CLI\nvar credential = new ChainedTokenCredential(); var client = new SecretClient(new Uri(\"https://mykv.vault.azure.net/\"), credential); ManagedIdentityCredential: Utiliza la Managed Identity para solicitar el token de autenticación\nvar credential = new ManagedIdentityCredential(); var client = new SecretClient(new Uri(\"https://mykv.vault.azure.net/\"), credential); El código final de nuestra Azure Function es el siguiente:\n[Function(\"GetSecret\")] public IActionResult GetSecret([HttpTrigger(AuthorizationLevel.Function, \"get\")] HttpRequest req, [FromQuery] string name, [FromQuery] string credentialType) { _logger.LogInformation(\"C# HTTP trigger function processed a request.\"); var kvName = _config[\"KV_NAME\"]; var tokenCredential = GetTokenCredential(credentialType); var client = new SecretClient(new Uri($\"https://{kvName}.vault.azure.net/\"), tokenCredential); return new OkObjectResult(client.GetSecret(name)); } private TokenCredential GetTokenCredential(string credentialType) { switch (credentialType) { case \"DefaultAzureCredential\": return new DefaultAzureCredential(); case \"ChainedTokenCredential\": return new ChainedTokenCredential(); case \"ManagedIdentityCredential\": return new ManagedIdentityCredential(); } throw new Exception($\"The credential type {credentialType} is not valid\"); } A continuación podemos ver el resultado de la ejecución de la Azure Function desde local y desde Azure:\nConclusión La utilización de Managed Identities no solo simplifica la gestión de credenciales, sino que también mejora significativamente la seguridad de las aplicaciones, al eliminar la necesidad de configurar y guardar secretos en archivos de configuración.\nPara los desarrolladores y arquitectos, utilizar Managed Identities debería ser una práctica estándar en la mayoría de los escenarios.\nReferencias https://learn.microsoft.com/en-us/training/modules/implement-managed-identities/5-acquire-access-token https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview https://learn.microsoft.com/en-us/entra/identity-platform/how-applications-are-added https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-connect-with-managed-identity https://learn.microsoft.com/en-us/dotnet/api/overview/azure/identity-readme https://learn.microsoft.com/es-es/azure/virtual-machines/instance-metadata-service ","wordCount":"963","inLanguage":"es","image":"https://blog.javivela.dev/papermod-cover.png","datePublished":"2024-10-03T00:00:00Z","dateModified":"2024-10-03T00:00:00Z","author":{"@type":"Person","name":"Javi Vela"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.javivela.dev/posts/2024/azure/managed-identities/"},"publisher":{"@type":"Organization","name":"Javi Vela Blog","logo":{"@type":"ImageObject","url":"https://blog.javivela.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.javivela.dev/ accesskey=h title="Javi Vela Blog (Alt + H)">Javi Vela Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.javivela.dev/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.javivela.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.javivela.dev/archives/ title=Archivos><span>Archivos</span></a></li><li><a href=https://blog.javivela.dev/search/ title=Buscar><span>Buscar</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.javivela.dev/>Inicio</a>&nbsp;»&nbsp;<a href=https://blog.javivela.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Azure Managed Identities</h1><div class=post-meta><span title='2024-10-03 00:00:00 +0000 UTC'>octubre 3, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Javi Vela</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Tabla de Contenidos</span></summary><div class=inner><ul><li><a href=#introducci%c3%b3n aria-label=Introducción>Introducción</a></li><li><a href=#tipos-de-managed-identities aria-label="Tipos de Managed Identities">Tipos de Managed Identities</a></li><li><a href=#c%c3%b3mo-funciona aria-label="¿Cómo funciona?">¿Cómo funciona?</a></li><li><a href=#habilitar-una-managed-identity-en-azure aria-label="Habilitar una Managed Identity en Azure">Habilitar una Managed Identity en Azure</a><ul><li><a href=#system-managed-identity aria-label="System Managed Identity">System Managed Identity</a></li><li><a href=#user-managed-identity aria-label="User Managed Identity">User Managed Identity</a></li></ul></li><li><a href=#como-acceder-a-un-recurso-en-azure-utilizando-una-managed-identity-utilizando-net aria-label="Como acceder a un recurso en Azure utilizando una Managed Identity utilizando .NET">Como acceder a un recurso en Azure utilizando una Managed Identity utilizando .NET</a></li><li><a href=#conclusi%c3%b3n aria-label=Conclusión>Conclusión</a></li><li><a href=#referencias aria-label=Referencias>Referencias</a></li></ul></div></details></div><div class=post-content><blockquote><p>Puedes encontrar el código fuente del post en el siguiente enlace: <a href=https://github.com/fjvela/blog-managed-identities>https://github.com/fjvela/blog-managed-identities</a></p></blockquote><h2 id=introducción>Introducción<a hidden class=anchor aria-hidden=true href=#introducción>#</a></h2><p>Uno de los grandes retos que tenemos hoy en día es gestionar la información sensible (credenciales, certificados, &mldr;) que nuestras aplicaciones necesitan.</p><p>Azure proporciona <em>Managed Identities</em> para simplificar la autenticación necesaria para acceder a los recursos desplegados en Azure como <strong><em>Azure Key Vault</em></strong>. Puedes comprobar la lista de servicios que soportan la autenticación a través de <em>Managed Identities</em> en el siguiente enlace: <a href=https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/managed-identities-status>https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/managed-identities-status</a></p><p>La utilización de <em>Managed Identities</em> tiene algunas ventajas:</p><ul><li>No es necesario utilizar y/o gestionar credenciales</li><li>Permite autenticarnos con cualquier otra aplicación (incluyendo nuestras propias aplicaciones)</li><li>No tiene un coste extra</li></ul><h2 id=tipos-de-managed-identities>Tipos de Managed Identities<a hidden class=anchor aria-hidden=true href=#tipos-de-managed-identities>#</a></h2><p>Existen dos tipos de <em>Managed Identities</em>:</p><ul><li><strong><em>System managed identities</em></strong>: Son creadas automáticamente por Azure cuando se crean algunos servicios como máquinas virtuales:<ul><li>Solo se puede utilizar por el servicio que la ha creado</li><li>Su ciclo de vida está asociado al ciclo de vida del recurso que lo ha creado (si borras el recurso, se borra la <em>Managed Identity</em>)</li><li>Automáticamente se crea un Service Principal en <em>Microsoft Entra ID</em> (directorio activo)</li><li>Debemos autorizar a qué servicios pueden acceder a la <em>Managed Identity</em></li></ul></li><li><strong><em>User managed identities</em></strong>: Podemos crear un <em>Managed Identity</em> y asignársela a más de una aplicación:<ul><li>Podemos utilizarla en una o varias aplicaciones</li><li>Debemos autorizar a qué servicios pueden acceder las aplicaciones que usen la <em>Managed Identity</em> creada</li><li>Automáticamente se crea un Service Principal en <em>Microsoft Entra ID</em> (directorio activo), su ciclo de vida no está asociado al ciclo de vida de la aplicación que lo utiliza</li></ul></li></ul><h2 id=cómo-funciona>¿Cómo funciona?<a hidden class=anchor aria-hidden=true href=#cómo-funciona>#</a></h2><p>Antes de explicar como funciona el proceso de creación y funcionamiento de una <em>managed identity</em>, debemos conocer qué es <em>Azure Instance Metadata Service identity (IMSI)</em>:</p><ul><li>Es un servicio REST interno disponible en la dirección IP: 169.254.169.254</li><li>Proporciona información sobre las instancias de VM en ejecución: Sistema operativo, mantenimientos programados, &mldr;</li><li>También proporciona tokens de autenticación que obtiene de <em>Microsoft Entra ID</em></li></ul><p><img alt="Diagrama funcionamiento managed identities" loading=lazy src=/2024/azure/managed-identities-como-funciona.png title="Diagrama funcionamiento managed identities"></p><ol><li><em>Azure Resource Manager</em> crea un <em>service principal</em> en <em>Microsoft Entra ID</em> asociado a la <em>Managed Identity</em> creada</li><li>A continuación <em>Azure Resource Manager</em>, actualiza <em>Azure Instance Metadata Service identity (IMSI)</em> proporcionando el ID el service principal y los certificados creados por <em>Microsoft Entra ID</em>. Más tarde serán necesarios para poder autenticarse contra <em>Microsoft Entra ID</em></li><li>En este paso, <em>Azure Resource Manager</em> habilita los permisos necesarios para acceder a otros recursos de Azure (Azure RBAC). Por ejemplo, asignar el rol <em>Key Vault Secrets User</em> para poder leer secretos de un <em>Azure Key Vault</em></li><li>Cuando nuestra aplicación necesita acceder al recurso, se comunica con el <em>IMSI</em>, el cual solicita un token de autenticación a Microsoft Entra ID (utilizando el service principal y certificados creados en el paso 2) que será utilizado por la aplicación para poder acceder a otros recursos desplegados en Azure.</li></ol><h2 id=habilitar-una-managed-identity-en-azure>Habilitar una Managed Identity en Azure<a hidden class=anchor aria-hidden=true href=#habilitar-una-managed-identity-en-azure>#</a></h2><p>Como hemos comentado, exiten dos tipos de <em>Managed Identites</em>: <strong><em>System managed identities</em></strong> y <strong><em>User managed identities</em></strong>. Vamos a ver como crear y habilitarlas en Azure.</p><blockquote><p>Una vez creada la managed identity, debemos asignar los permisos correspondientes de acceso.</p></blockquote><h3 id=system-managed-identity>System Managed Identity<a hidden class=anchor aria-hidden=true href=#system-managed-identity>#</a></h3><p>Para crear un System Managed Identity asociado a un recurso de Azure tan solo debemos seleccionarlo desde el portal y en el menu &ldquo;Identity&rdquo;, habilitarlo y guardar los cambios realizados.</p><p><img alt="Como habilitar System Managed Identity en Azure Functions" loading=lazy src=/2024/azure/managed-identities-habilitar-system-managed-identity.png title="Como habilitar System Managed Identity en Azure Functions"></p><p><img alt="System Managed Identity en Azure Functions creada" loading=lazy src=/2024/azure/managed-identities-system-managed-identity-creada.png title="System Managed Identity en Azure Functions creada"></p><h3 id=user-managed-identity>User Managed Identity<a hidden class=anchor aria-hidden=true href=#user-managed-identity>#</a></h3><p>Desde el apartado &ldquo;Managed Identities&rdquo; podemos crear <em>User Managed Identites</em>, una vez completados los datos requeridos debemos asignar la <em>managed identity</em> al recurso o recursos que harán uso de ella.</p><p><img alt="Como crear una User Managed Identity" loading=lazy src=/2024/azure/managed-identities-crear-user-managed-identity.png title="Como crear una User Managed Identity"></p><p><img alt="Como asignar una User Managed Identity a una Azure Functions" loading=lazy src=/2024/azure/managed-identities-asignar-user-managed-identity.png title="Como asignar una User Managed Identity a una Azure Functions"></p><p><img alt="User Managed Identity asignada a una Azure Functions" loading=lazy src=/2024/azure/managed-identities-user-managed-identity-asignada.png title="User Managed Identity asignada a una Azure Functions"></p><h2 id=como-acceder-a-un-recurso-en-azure-utilizando-una-managed-identity-utilizando-net>Como acceder a un recurso en Azure utilizando una Managed Identity utilizando .NET<a hidden class=anchor aria-hidden=true href=#como-acceder-a-un-recurso-en-azure-utilizando-una-managed-identity-utilizando-net>#</a></h2><p>Podemos hacer uso de las <em>Managed Identities</em> creadas en Azure a través de los diferentes SDKs disponibles o implementando el código necesario para poder interactuar con el API REST proporcionado por la IMSI y así obtener los tokens de autenticación para acceder a otros recursos de Azure.</p><p>Vamos a describir cómo podemos acceder a un <em>Azure Key Vault</em> utilizando código .NET y la librería <a href=https://learn.microsoft.com/en-us/dotnet/api/azure.identity>Azure.Identity</a>:</p><ol><li>Crea una proyecto .NET, en este caso hemos creado un proyecto tipo Azure Functions para facilitar su despliegue en Azure</li><li>Añade la referencia a la librería Azure.Identity <code>dotnet add package Azure.Identity</code></li></ol><p>Azure.Identity proporciona varias clases que encapsulan la lógica necesaria para poder obtener un token de autenticación de Microsoft Entra ID haciendo uso de la <em>Managed Identity</em> configurada a través de la IMSI:</p><p><strong><em>DefaultAzureCredential:</em></strong> Intenta realizar la autenticación a través de diferentes mecanismos hasta que consigue conectarse con uno de ellos.
<img alt="Diagrama funcionamiento DefaultAzureCredential" loading=lazy src=/2024/azure/managed-identities-DefaultAzureCredential.png title="Diagrama funcionamiento DefaultAzureCredential"></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> credential = <span style=color:#66d9ef>new</span> DefaultAzureCredential();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> client = <span style=color:#66d9ef>new</span> SecretClient(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;https://mykv.vault.azure.net/&#34;</span>), credential);
</span></span></code></pre></div><p><strong><em>ChainedTokenCredential:</em></strong> Intenta realizar la autenticación a través de la <em>Managed Identity</em>. Si no lo consigue, intenta conectarse utilizando a través de Azure CLI</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> credential = <span style=color:#66d9ef>new</span> ChainedTokenCredential();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> client = <span style=color:#66d9ef>new</span> SecretClient(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;https://mykv.vault.azure.net/&#34;</span>), credential);
</span></span></code></pre></div><p><strong><em>ManagedIdentityCredential:</em></strong> Utiliza la <em>Managed Identity</em> para solicitar el token de autenticación</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> credential = <span style=color:#66d9ef>new</span> ManagedIdentityCredential();
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> client = <span style=color:#66d9ef>new</span> SecretClient(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;https://mykv.vault.azure.net/&#34;</span>), credential);
</span></span></code></pre></div><p>El código final de nuestra Azure Function es el siguiente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>  [Function(&#34;GetSecret&#34;)]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> IActionResult GetSecret([HttpTrigger(AuthorizationLevel.Function, <span style=color:#e6db74>&#34;get&#34;</span>)] HttpRequest req, 
</span></span><span style=display:flex><span><span style=color:#a6e22e>      [FromQuery]</span> <span style=color:#66d9ef>string</span> name,
</span></span><span style=display:flex><span><span style=color:#a6e22e>      [FromQuery]</span> <span style=color:#66d9ef>string</span> credentialType)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      _logger.LogInformation(<span style=color:#e6db74>&#34;C# HTTP trigger function processed a request.&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> kvName = _config[<span style=color:#e6db74>&#34;KV_NAME&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> tokenCredential = GetTokenCredential(credentialType);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> client = <span style=color:#66d9ef>new</span> SecretClient(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>$&#34;https://{kvName}.vault.azure.net/&#34;</span>), tokenCredential);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> OkObjectResult(client.GetSecret(name));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> TokenCredential GetTokenCredential(<span style=color:#66d9ef>string</span> credentialType)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (credentialType) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;DefaultAzureCredential&#34;</span>:
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultAzureCredential();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ChainedTokenCredential&#34;</span>:
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ChainedTokenCredential();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;ManagedIdentityCredential&#34;</span>:
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ManagedIdentityCredential();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>$&#34;The credential type {credentialType} is not valid&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>A continuación podemos ver el resultado de la ejecución de la Azure Function desde local y desde Azure:</p><p><img alt="Resultado ejecución Azure Function desde local" loading=lazy src=/2024/azure/managed-identities-resultado-ejecucion-local.png title="Resultado ejecución Azure Function desde local"></p><p><img alt="Resultado ejecución Azure Function desde Azure" loading=lazy src=/2024/azure/managed-identities-resultado-ejecucion-azure.png title="Resultado ejecución Azure Function desde Azure"></p><h2 id=conclusión>Conclusión<a hidden class=anchor aria-hidden=true href=#conclusión>#</a></h2><p>La utilización de <em>Managed Identities</em> no solo simplifica la gestión de credenciales, sino que también mejora significativamente la seguridad de las aplicaciones, al eliminar la necesidad de configurar y guardar secretos en archivos de configuración.</p><p>Para los desarrolladores y arquitectos, utilizar <em>Managed Identities</em> debería ser una práctica estándar en la mayoría de los escenarios.</p><h2 id=referencias>Referencias<a hidden class=anchor aria-hidden=true href=#referencias>#</a></h2><ul><li><a href=https://learn.microsoft.com/en-us/training/modules/implement-managed-identities/5-acquire-access-token>https://learn.microsoft.com/en-us/training/modules/implement-managed-identities/5-acquire-access-token</a></li><li><a href=https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview>https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/overview</a></li><li><a href=https://learn.microsoft.com/en-us/entra/identity-platform/how-applications-are-added>https://learn.microsoft.com/en-us/entra/identity-platform/how-applications-are-added</a></li><li><a href=https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-connect-with-managed-identity>https://learn.microsoft.com/en-us/azure/postgresql/single-server/how-to-connect-with-managed-identity</a></li><li><a href=https://learn.microsoft.com/en-us/dotnet/api/overview/azure/identity-readme>https://learn.microsoft.com/en-us/dotnet/api/overview/azure/identity-readme</a></li><li><a href=https://learn.microsoft.com/es-es/azure/virtual-machines/instance-metadata-service>https://learn.microsoft.com/es-es/azure/virtual-machines/instance-metadata-service</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.javivela.dev/tags/azure/>Azure</a></li><li><a href=https://blog.javivela.dev/tags/security/>Security</a></li><li><a href=https://blog.javivela.dev/tags/microsoft-entra/>Microsoft Entra</a></li><li><a href=https://blog.javivela.dev/tags/identity/>Identity</a></li></ul><nav class=paginav><a class=prev href=https://blog.javivela.dev/posts/2024/azure/federated-identity-credential/><span class=title>« Anterior</span><br><span>Azure Federated Identity Credentials</span>
</a><a class=next href=https://blog.javivela.dev/posts/2024/dotnet/csharp-13-net-9-preview-6/><span class=title>Siguiente »</span><br><span>Novedades en C# 13 (.NET 9 preview 6)</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on x" href="https://x.com/intent/tweet/?text=Azure%20Managed%20Identities&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f&amp;hashtags=Azure%2cSecurity%2cMicrosoftEntra%2cIdentity"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f&amp;title=Azure%20Managed%20Identities&amp;summary=Azure%20Managed%20Identities&amp;source=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f&title=Azure%20Managed%20Identities"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on whatsapp" href="https://api.whatsapp.com/send?text=Azure%20Managed%20Identities%20-%20https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on telegram" href="https://telegram.me/share/url?text=Azure%20Managed%20Identities&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Managed Identities on ycombinator" href="https://news.ycombinator.com/submitlink?t=Azure%20Managed%20Identities&u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2024%2fazure%2fmanaged-identities%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.javivela.dev/>Javi Vela Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a> &
<a href=https://librecounter.org/ rel=noopener target=_blank>LibreCounter</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><img src=https://librecounter.org/counter.svg referrerpolicy=unsafe-url width=0>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copiar";function s(){t.innerHTML="¡copiado!",setTimeout(()=>{t.innerHTML="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>