<!doctype html><html lang=es dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS | Javi Vela Blog</title><meta name=keywords content="Kubernetes,aks,k8s,secrets,seguridad"><meta name=description content="Introducción
En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.
Desplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto Secret no sea el mas adecuado.
A lo largo del post vamos a ver como instalar y configurar Azure Key Vault Provider for Secrets Store CSI Driver, este componente nos va a permitir leer información de un Azure Key Vault y proporcionarla a un Pod a través de un fichero o una variable de entorno."><meta name=author content="Javi Vela"><link rel=canonical href=https://blog.javivela.dev/posts/2022/kubernetes/azure-key-vault-secret-store-csi/><meta name=google-site-verification content="Z9k5TW79n5H64zWLwEcNkbNITNDDepKoE2udZjirxXM"><meta name=msvalidate.01 content="6A293DF736526A40A24D911811A73F7D"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.javivela.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.javivela.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.javivela.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.javivela.dev/apple-touch-icon.png><link rel=mask-icon href=https://blog.javivela.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=es href=https://blog.javivela.dev/posts/2022/kubernetes/azure-key-vault-secret-store-csi/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://blog.javivela.dev/posts/2022/kubernetes/azure-key-vault-secret-store-csi/"><meta property="og:site_name" content="Javi Vela Blog"><meta property="og:title" content="Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS"><meta property="og:description" content="Introducción En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.
Desplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto Secret no sea el mas adecuado.
A lo largo del post vamos a ver como instalar y configurar Azure Key Vault Provider for Secrets Store CSI Driver, este componente nos va a permitir leer información de un Azure Key Vault y proporcionarla a un Pod a través de un fichero o una variable de entorno."><meta property="og:locale" content="es"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-13T00:00:00+00:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Aks"><meta property="article:tag" content="K8S"><meta property="article:tag" content="Secrets"><meta property="article:tag" content="Seguridad"><meta property="og:image" content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.javivela.dev/papermod-cover.png"><meta name=twitter:title content="Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS"><meta name=twitter:description content="Introducción
En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.
Desplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto Secret no sea el mas adecuado.
A lo largo del post vamos a ver como instalar y configurar Azure Key Vault Provider for Secrets Store CSI Driver, este componente nos va a permitir leer información de un Azure Key Vault y proporcionarla a un Pod a través de un fichero o una variable de entorno."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.javivela.dev/posts/"},{"@type":"ListItem","position":2,"name":"Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS","item":"https://blog.javivela.dev/posts/2022/kubernetes/azure-key-vault-secret-store-csi/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS","name":"Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS","description":"Introducción En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.\nDesplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto Secret no sea el mas adecuado.\nA lo largo del post vamos a ver como instalar y configurar Azure Key Vault Provider for Secrets Store CSI Driver, este componente nos va a permitir leer información de un Azure Key Vault y proporcionarla a un Pod a través de un fichero o una variable de entorno.\n","keywords":["Kubernetes","aks","k8s","secrets","seguridad"],"articleBody":"Introducción En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.\nDesplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto Secret no sea el mas adecuado.\nA lo largo del post vamos a ver como instalar y configurar Azure Key Vault Provider for Secrets Store CSI Driver, este componente nos va a permitir leer información de un Azure Key Vault y proporcionarla a un Pod a través de un fichero o una variable de entorno.\nAzure Key Vault Provider for Secrets Store CSI Driver Container Store Driver (CSI) es una interfaz que implementan los cloud provider para que los orquestadores de contenedores (Kubernetes, Mesos, Nomad,…) puedan hacer uso de sus sistemas de almacenamiento a través de una interfaz agnostica a la tecnologia subyacente.\nSecrets Store CSI Driver Provider Permite leer información sensible o confidencial (secretos, certificados,…) de un origen (ej. Azure Key Vault, Amazon Secrets o Google Secret Manager…) montarlos en un Pod utilizando la interfaz Container Store Driver (CSI) o crear automáticamente un secreto con esta información únicamente cuando exista algún Pod que requiera esta información.\nAzure Key Vault Provider Secret Store CSI Driver, nos permite leer información almacenada en un Azure Key Vault y montarla en un Pod utilizando la interfaz CSI. Puede utilizarse en cualquier orquestador de contenedores.\nInstalación Si no tienes desplegado un cluster de kubernetes en Azure puedes utilizar el código de terraform de este repositorio para desplegar uno. Para facilitar la prueba, el cluster es público - ¡No uses este código para desplegar un clúster en un entorno productivo! Recuerda borrarlo una vez finalizadas las pruebas para evitar problemas y/o costes innecesarios.\nPara seguir el post, deberás tener instaladas las siguientes herramientas:\nHelm3 Kubectl cli Az cli Para empezar con la instalación debemos decidir qué método de autenticación utilizará Azure Key Vault Provider for Secrets Store CSI Driver para leer los secretos del Azure Key Vault. Actualmente existen varios mecanismos:\nWorkload Identity Managed Identities (System-assigned and User-assigned) Service Principal Vamos a utilizar Service Principal. Dependiendo de nuestro caso de uso quizá no sea el más recomendable ya que deberemos crear un secreto para almacenar la información de autenticación, pero es el método de autenticación más rápido y sencillo de configurar.\nCrear service principal (SP) Creamos un service principal (SP) ejecutando el siguiente comando:\naz ad sp create-for-rbac -n sp-secrets-store-csi-driver-provider-azure Una vez creado el Service Principal creamos un secreto en nuestro clúster Kubernetes con los valores de las claves appId (usa el valor de la propiedad clientid) y password (usa el valor de la propiedad clientsecret) y etiquetamos el secreto con la etiqueta secrets-store-creds secrets-store.csi.k8s.io/used=true\nkubectl create secret generic secrets-store-creds --from-literal clientid= --from-literal clientsecret= -n myapp kubectl label secret secrets-store-creds secrets-store.csi.k8s.io/used=true -n myapp Crear Azure Key Vault Creamos el Azure Key Vault donde almacenaremos nuestros secretos y añadimos un secreto:\naz keyvault create --name \"kv-secret-store-csi-001\" --resource-group \"rg-secret-store-westeu\" --location \"westeurope\" az keyvault secret set --name \"mysupersecret\" --vault-name \"kv-secret-store-csi-001\" --value \"MyVaultValueSecret\" Asignamos permisos de lectura para que el service principal que hemos creado anteriormente pueda leer los secretos:\naz keyvault set-policy -n \"kv-secret-store-csi-001\" --secret-permissions list get --spn Instalación Azure Key Vault Provider Secret Store CSI Driver Podemos instalar Azure Key Vault Provider Secret Store CSI Driver de varias maneras:\nHelm 3 Deployment yamls En el caso de que estemos utilizando un clúster AKS, podemos habilitar el addon azure-keyvault-secrets-provider utilizando az cli: https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#enable-and-disable-autorotation (tiene soporte oficial) En nuestro caso vamos a utilizar Helm. Para ello, agregamos el repositorio secrets-store-csi-driver-provider-azure e instalamos el chart csi-secrets-store-provider-azure/csi-secrets-store-provider-azure en el namespace kube-system:\nhelm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts helm install csi csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --namespace kube-system --set secrets-store-csi-driver.syncSecret.enabled=true El chart permite configurar los componentes desplegados, puedes comprobar todos los parámetros de configuración aquí.\nUna vez instalado, comprobamos que los componentes han arrancado correctamente:\nkubectl get pods -l app=csi-secrets-store-provider-azure -n kube-system Caso de uso: montar la información de un secreto a través de un fichero A continuación creamos un objeto de tipo SecretProviderClass. Este objeto nos permite configurar el Azure Key Vault del que vamos a leer. Puedes encontrar una descripción de todos los parámetros de configuración aquí.\napiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: azure-kv-secret-store-csi-mount-file spec: provider: azure parameters: keyvaultName: \"kv-secret-store-csi-001\" # the name of the KeyVault tenantId: \"YOUR_TENANT_ID\" # the tenant ID of the KeyVault objects: | array: - | objectName: mysupersecret objectAlias: mysupersecret # [OPTIONAL available for version \u003e 0.0.4] object alias objectType: secret # object types: secret, key or cert. For Key Vault certificates, refer to https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/getting-certs-and-keys/ for the object type to use objectVersion: \"\" # [OPTIONAL] object versions, default to latest if empty filePermission: 0755 # [OPTIONAL] permission for secret file being mounted into the Pod, default is 0644 if not specified. El siguiente paso será crear un Pod y configurar un volumen para montar los secretos que necesitamos en un directorio:\nkind: Pod apiVersion: v1 metadata: name: busybox-secrets-store-mount-file spec: containers: - name: busybox image: k8s.gcr.io/e2e-test-images/busybox:1.29 command: - \"/bin/sleep\" - \"10000\" volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"azure-kv-secret-store-csi-mount-file\" nodePublishSecretRef: # Only required when using service principal mode name: secrets-store-creds # Only required when using service principal mode. The name of the Kubernetes secret that contains the service principal credentials to access keyvault. Ejecutamos el siguiente comando para comprobar el contenido del fichero montado automáticamente por el componente:\nkubectl exec busybox-secrets-store-mount-file -n myapp -- cat /mnt/secrets-store/mysupersecret Caso de uso: montar la información de un secreto a través de una variable de entorno El valor del parámetro syncSecret.enabled debe estar configurado a ’true’\nLa configuración para crear un secreto automáticamente, es muy similar. Tan solo tenemos que agregar el bloque de configuración secretObjects:\nsecretObjects: # [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects - secretName: secret-created-automatically # name of the Kubernetes secret object type: Opaque # type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls) data: - key: mysupersecret # data field to populate objectName: mysupersecretalias # this could be the object name or the object alias La configuración completa quedaria de la siguiente manera:\napiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: azure-kv-secret-store-csi-mount-env-var spec: provider: azure parameters: keyvaultName: \"kv-secret-store-csi-001\" # the name of the KeyVault tenantId: \"328214bc-e88f-43fb-bad1-8f64ff51d823\" # the tenant ID of the KeyVault objects: | array: - | objectName: mysupersecret objectAlias: mysupersecretalias # [OPTIONAL available for version \u003e 0.0.4] object alias objectType: secret # object types: secret, key or cert. For Key Vault certificates, refer to https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/getting-certs-and-keys/ for the object type to use objectVersion: \"\" # [OPTIONAL] object versions, default to latest if empty secretObjects: # [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects - secretName: secret-created-automatically # name of the Kubernetes secret object type: Opaque # type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls) data: - key: mysupersecret # data field to populate objectName: mysupersecretalias # this could be the object name or the object alias Desplegamos un Pod configurando el secreto como una variable de entorno:\nkind: Pod apiVersion: v1 metadata: name: busybox-secrets-store-mount-env-var spec: containers: - name: busybox image: k8s.gcr.io/e2e-test-images/busybox:1.29 command: - \"/bin/sleep\" - \"10000\" env: - name: SECRET_CREDENTIALS valueFrom: secretKeyRef: name: secret-created-automatically key: mysupersecret volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"azure-kv-secret-store-csi-mount-env-var\" nodePublishSecretRef: # Only required when using service principal mode name: secrets-store-creds # Only required when using service principal mode. The name of the Kubernetes secret that contains the service principal credentials to access keyvault. Ejecutamos el siguiente comando para comprobar el contenido de la variable de entorno:\nkubectl exec busybox-secrets-store-mount-env-var -n myapp -- env | grep SECRET_CREDENTIALS Rotación de secretos Azure Key Vault Provider Secret Store CSI Driver puede actualizar el valor de un secreto en el caso de que haya sido actualizado en el Azure Key Vault. Actualmente es una funcionalidad en estado alpha, para poder hacer uso de ella debemos habilitarla a través del parámetro secrets-store-csi-driver.enableSecretRotation.\nEsta funcionalidad tiene algunas limitaciones como por ejemplo que no actualiza correctamente el valor de los secretos en Kubernetes (https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/1007).\nMétricas Azure Key Vault Provider for Secrets Store CSI Driver nos ofrece diferentes métricas que podemos integrar con Prometheus.\nPara Poder consultar las métricas del componente Azure Key Vault Provider ejecuta el siguiente comando:\nkubectl port-forward -n kube-system ds/csi-csi-secrets-store-provider-azure 8898:8898 \u0026 curl localhost:8898/metrics Para poder consultar las métricas del componente Secrets Store CSI Driver ejecuta el siguiente comando:\nkubectl port-forward -n kube-system ds/secrets-store-csi-driver 8080:8080 \u0026 curl http://localhost:8080/metrics Puedes encontrar una descripción completa de todas las metricas en el siguiente enlace: https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics\nLos nombres de los daemon set y puertos pueden variar dependiendo de los parámetros de configuración.\nReferencias https://github.com/container-storage-interface https://kubernetes-csi.github.io/docs/ https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/ https://github.com/aws/secrets-store-csi-driver-provider-aws https://github.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics ","wordCount":"1464","inLanguage":"es","image":"https://blog.javivela.dev/papermod-cover.png","datePublished":"2022-12-13T00:00:00Z","dateModified":"2022-12-13T00:00:00Z","author":{"@type":"Person","name":"Javi Vela"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.javivela.dev/posts/2022/kubernetes/azure-key-vault-secret-store-csi/"},"publisher":{"@type":"Organization","name":"Javi Vela Blog","logo":{"@type":"ImageObject","url":"https://blog.javivela.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.javivela.dev/ accesskey=h title="Javi Vela Blog (Alt + H)">Javi Vela Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://blog.javivela.dev/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://blog.javivela.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.javivela.dev/archives/ title=Archivos><span>Archivos</span></a></li><li><a href=https://blog.javivela.dev/search/ title=Buscar><span>Buscar</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.javivela.dev/>Inicio</a>&nbsp;»&nbsp;<a href=https://blog.javivela.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS</h1><div class=post-meta><span title='2022-12-13 00:00:00 +0000 UTC'>diciembre 13, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Javi Vela</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Tabla de Contenidos</span></summary><div class=inner><ul><li><a href=#introducci%c3%b3n aria-label=Introducción>Introducción</a></li><li><a href=#azure-key-vault-provider-for-secrets-store-csi-driver aria-label="Azure Key Vault Provider for Secrets Store CSI Driver">Azure Key Vault Provider for Secrets Store CSI Driver</a><ul><li><a href=#instalaci%c3%b3n aria-label=Instalación>Instalación</a><ul><li><a href=#crear-service-principal-sp aria-label="Crear service principal (SP)">Crear service principal (SP)</a></li><li><a href=#crear-azure-key-vault aria-label="Crear Azure Key Vault">Crear Azure Key Vault</a></li><li><a href=#instalaci%c3%b3n-azure-key-vault-provider-secret-store-csi-driver aria-label="Instalación Azure Key Vault Provider Secret Store CSI Driver">Instalación Azure Key Vault Provider Secret Store CSI Driver</a></li></ul></li><li><a href=#caso-de-uso-montar-la-informaci%c3%b3n-de-un-secreto-a-trav%c3%a9s-de-un-fichero aria-label="Caso de uso: montar la información de un secreto a través de un fichero">Caso de uso: montar la información de un secreto a través de un fichero</a></li><li><a href=#caso-de-uso-montar-la-informaci%c3%b3n-de-un-secreto-a-trav%c3%a9s-de-una-variable-de-entorno aria-label="Caso de uso: montar la información de un secreto a través de una variable de entorno">Caso de uso: montar la información de un secreto a través de una variable de entorno</a></li><li><a href=#rotaci%c3%b3n-de-secretos aria-label="Rotación de secretos">Rotación de secretos</a></li><li><a href=#m%c3%a9tricas aria-label=Métricas>Métricas</a></li></ul></li><li><a href=#referencias aria-label=Referencias>Referencias</a></li></ul></div></details></div><div class=post-content><h2 id=introducción>Introducción<a hidden class=anchor aria-hidden=true href=#introducción>#</a></h2><p>En algunas ocasiones nuestras aplicaciones desplegadas en kubernetes necesitan información sensible y/o confidencial tales como una contraseña de una base de datos o un token para conectarse a otras aplicaciones.</p><p>Desplegar y mantener esta información en nuestro cluster no es siempre trivial o sencilla y en determinados casos de uso es posible que el tipo de objecto <a href=https://kubernetes.io/docs/concepts/configuration/secret/><em>Secret</em></a> no sea el mas adecuado.</p><p>A lo largo del post vamos a ver como instalar y configurar <strong>Azure Key Vault Provider for Secrets Store CSI Driver</strong>, este componente nos va a permitir leer información de un <strong>Azure Key Vault</strong> y proporcionarla a un Pod a través de un fichero o una variable de entorno.</p><h2 id=azure-key-vault-provider-for-secrets-store-csi-driver>Azure Key Vault Provider for Secrets Store CSI Driver<a hidden class=anchor aria-hidden=true href=#azure-key-vault-provider-for-secrets-store-csi-driver>#</a></h2><p><strong>Container Store Driver (CSI)</strong> es una interfaz que implementan los cloud provider para que los orquestadores de contenedores (<a href=https://kubernetes-csi.github.io/docs/>Kubernetes</a>, <a href=https://mesos.apache.org/documentation/latest/csi/>Mesos</a>, <a href=https://developer.hashicorp.com/nomad/docs/concepts/plugins/csi>Nomad</a>,&mldr;) puedan hacer uso de sus sistemas de almacenamiento a través de una interfaz agnostica a la tecnologia subyacente.</p><p><strong>Secrets Store CSI Driver Provider</strong> Permite leer información sensible o confidencial (secretos, certificados,&mldr;) de un origen (ej. Azure Key Vault, Amazon Secrets o Google Secret Manager&mldr;) montarlos en un Pod utilizando la interfaz Container Store Driver (CSI) o crear automáticamente un secreto con esta información únicamente cuando exista algún Pod que requiera esta información.</p><p><strong>Azure Key Vault Provider Secret Store CSI Driver</strong>, nos permite leer información almacenada en un <strong>Azure Key Vault</strong> y montarla en un Pod utilizando la interfaz CSI. Puede utilizarse en cualquier orquestador de contenedores.</p><h3 id=instalación>Instalación<a hidden class=anchor aria-hidden=true href=#instalación>#</a></h3><blockquote><p>Si no tienes desplegado un cluster de kubernetes en Azure puedes utilizar el código de terraform de este <a href=https://github.com/fjvela/poc-k8s/tree/main/terraform/azure-aks>repositorio</a> para desplegar uno. Para facilitar la prueba, el cluster es público - ¡No uses este código para desplegar un clúster en un entorno productivo! Recuerda borrarlo una vez finalizadas las pruebas para evitar problemas y/o costes innecesarios.</p></blockquote><p>Para seguir el post, deberás tener instaladas las siguientes herramientas:</p><ul><li><a href=https://helm.sh/docs/intro/install/>Helm3</a></li><li><a href=https://kubernetes.io/docs/tasks/tools/#kubectl>Kubectl cli</a></li><li><a href=https://learn.microsoft.com/en-us/cli/azure/install-azure-cli>Az cli</a></li></ul><p>Para empezar con la instalación debemos decidir qué método de autenticación utilizará <strong>Azure Key Vault Provider for Secrets Store CSI Driver</strong> para leer los secretos del Azure Key Vault. Actualmente existen varios mecanismos:</p><ul><li>Workload Identity</li><li>Managed Identities (System-assigned and User-assigned)</li><li>Service Principal</li></ul><p>Vamos a utilizar <strong>Service Principal</strong>. Dependiendo de nuestro caso de uso quizá no sea el más recomendable ya que deberemos crear un secreto para almacenar la información de autenticación, pero es el método de autenticación más rápido y sencillo de configurar.</p><h4 id=crear-service-principal-sp>Crear service principal (SP)<a hidden class=anchor aria-hidden=true href=#crear-service-principal-sp>#</a></h4><p>Creamos un service principal (SP) ejecutando el siguiente comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az ad sp create-for-rbac -n sp-secrets-store-csi-driver-provider-azure
</span></span></code></pre></div><p>Una vez creado el <code>Service Principal</code> creamos un secreto en nuestro clúster Kubernetes con los valores de las claves <code>appId</code> (usa el valor de la propiedad clientid) y <code>password</code> (usa el valor de la propiedad clientsecret) y etiquetamos el secreto con la etiqueta <code>secrets-store-creds secrets-store.csi.k8s.io/used=true</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create secret generic secrets-store-creds --from-literal clientid<span style=color:#f92672>=</span>&lt;AZURE_CLIENT_ID&gt; --from-literal clientsecret<span style=color:#f92672>=</span>&lt;AZURE_CLIENT_SECRET&gt; -n myapp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl label secret secrets-store-creds secrets-store.csi.k8s.io/used<span style=color:#f92672>=</span>true -n myapp
</span></span></code></pre></div><h4 id=crear-azure-key-vault>Crear Azure Key Vault<a hidden class=anchor aria-hidden=true href=#crear-azure-key-vault>#</a></h4><p>Creamos el Azure Key Vault donde almacenaremos nuestros secretos y añadimos un secreto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az keyvault create --name <span style=color:#e6db74>&#34;kv-secret-store-csi-001&#34;</span> --resource-group <span style=color:#e6db74>&#34;rg-secret-store-westeu&#34;</span> --location <span style=color:#e6db74>&#34;westeurope&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>az keyvault secret set --name <span style=color:#e6db74>&#34;mysupersecret&#34;</span> --vault-name <span style=color:#e6db74>&#34;kv-secret-store-csi-001&#34;</span> --value <span style=color:#e6db74>&#34;MyVaultValueSecret&#34;</span>
</span></span></code></pre></div><p>Asignamos permisos de lectura para que el <code>service principal</code> que hemos creado anteriormente pueda leer los secretos:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>az keyvault set-policy -n <span style=color:#e6db74>&#34;kv-secret-store-csi-001&#34;</span> --secret-permissions list get  --spn  &lt;SERVICE_PRINCIPAL_ID&gt;
</span></span></code></pre></div><h4 id=instalación-azure-key-vault-provider-secret-store-csi-driver>Instalación Azure Key Vault Provider Secret Store CSI Driver<a hidden class=anchor aria-hidden=true href=#instalación-azure-key-vault-provider-secret-store-csi-driver>#</a></h4><p>Podemos instalar Azure Key Vault Provider Secret Store CSI Driver de varias maneras:</p><ul><li>Helm 3</li><li>Deployment yamls</li><li>En el caso de que estemos utilizando un clúster AKS, podemos habilitar el addon <code>azure-keyvault-secrets-provider</code> utilizando <code>az cli</code>: <a href=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#enable-and-disable-autorotation>https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#enable-and-disable-autorotation</a> (tiene soporte oficial)</li></ul><p>En nuestro caso vamos a utilizar Helm. Para ello, agregamos el repositorio <code>secrets-store-csi-driver-provider-azure</code> e instalamos el chart <code>csi-secrets-store-provider-azure/csi-secrets-store-provider-azure</code> en el namespace <code>kube-system</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm install csi csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --namespace kube-system --set secrets-store-csi-driver.syncSecret.enabled<span style=color:#f92672>=</span>true
</span></span></code></pre></div><p>El chart permite configurar los componentes desplegados, puedes comprobar todos los parámetros de configuración <a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/blob/master/charts/csi-secrets-store-provider-azure/README.md#configuration>aquí</a>.</p><p>Una vez instalado, comprobamos que los componentes han arrancado correctamente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -l app<span style=color:#f92672>=</span>csi-secrets-store-provider-azure -n kube-system
</span></span></code></pre></div><p><img alt="Resultado ejecución &lsquo;kubectl get Pods -l app=csi-secrets-store-provider-azure -n kube-system&rsquo;. Dos Pods en estado running" loading=lazy src=/2022/kubernetes/secrets-store-csi-driver-provider-azure-running-pods.png></p><h3 id=caso-de-uso-montar-la-información-de-un-secreto-a-través-de-un-fichero>Caso de uso: montar la información de un secreto a través de un fichero<a hidden class=anchor aria-hidden=true href=#caso-de-uso-montar-la-información-de-un-secreto-a-través-de-un-fichero>#</a></h3><p>A continuación creamos un objeto de tipo <code>SecretProviderClass</code>. Este objeto nos permite configurar el Azure Key Vault del que vamos a leer. Puedes encontrar una descripción de todos los parámetros de configuración <a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/getting-started/usage/#create-your-own-secretproviderclass-object>aquí</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>secrets-store.csi.x-k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecretProviderClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>azure-kv-secret-store-csi-mount-file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>azure</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>parameters</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>keyvaultName</span>: <span style=color:#e6db74>&#34;kv-secret-store-csi-001&#34;</span> <span style=color:#75715e># the name of the KeyVault</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tenantId</span>: <span style=color:#e6db74>&#34;YOUR_TENANT_ID&#34;</span> <span style=color:#75715e># the tenant ID of the KeyVault</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>objects</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      array:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectName: mysupersecret
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectAlias: mysupersecret           # [OPTIONAL available for version &gt; 0.0.4] object alias
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectType: secret              # object types: secret, key or cert. For Key Vault certificates, refer to https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/getting-certs-and-keys/ for the object type to use
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectVersion: &#34;&#34;               # [OPTIONAL] object versions, default to latest if empty
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          filePermission: 0755            # [OPTIONAL] permission for secret file being mounted into the Pod, default is 0644 if not specified.</span>
</span></span></code></pre></div><p>El siguiente paso será crear un Pod y configurar un volumen para montar los secretos que necesitamos en un directorio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>busybox-secrets-store-mount-file</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>busybox</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>k8s.gcr.io/e2e-test-images/busybox:1.29</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;/bin/sleep&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;10000&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-inline</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/mnt/secrets-store&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-inline</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>csi</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>secrets-store.csi.k8s.io</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeAttributes</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>secretProviderClass</span>: <span style=color:#e6db74>&#34;azure-kv-secret-store-csi-mount-file&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>nodePublishSecretRef</span>: <span style=color:#75715e># Only required when using service principal mode</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-creds</span> <span style=color:#75715e># Only required when using service principal mode. The name of the Kubernetes secret that contains the service principal credentials to access keyvault.</span>
</span></span></code></pre></div><p>Ejecutamos el siguiente comando para comprobar el contenido del fichero montado automáticamente por el componente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl exec busybox-secrets-store-mount-file -n myapp -- cat  /mnt/secrets-store/mysupersecret
</span></span></code></pre></div><p><img alt="Resultado ejecución &lsquo;kubectl exec busybox-secrets-store-mount-file -n myapp &ndash; cat  /mnt/secrets-store/mysupersecret&rsquo;. Muestra &lsquo;MyVaultValueSecret&rsquo;" loading=lazy src=/2022/kubernetes/secrets-store-csi-driver-provider-azure-result-mount-file.png></p><h3 id=caso-de-uso-montar-la-información-de-un-secreto-a-través-de-una-variable-de-entorno>Caso de uso: montar la información de un secreto a través de una variable de entorno<a hidden class=anchor aria-hidden=true href=#caso-de-uso-montar-la-información-de-un-secreto-a-través-de-una-variable-de-entorno>#</a></h3><blockquote><p>El valor del parámetro <strong>syncSecret.enabled</strong> debe estar configurado a <strong>&rsquo;true&rsquo;</strong></p></blockquote><p>La configuración para crear un secreto automáticamente, es muy similar. Tan solo tenemos que agregar el bloque de configuración <code>secretObjects</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>secretObjects</span>: <span style=color:#75715e># [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>secret-created-automatically</span> <span style=color:#75715e># name of the Kubernetes secret object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Opaque</span> <span style=color:#75715e># type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>mysupersecret</span> <span style=color:#75715e># data field to populate</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>objectName</span>: <span style=color:#ae81ff>mysupersecretalias</span> <span style=color:#75715e># this could be the object name or the object alias</span>
</span></span></code></pre></div><p>La configuración completa quedaria de la siguiente manera:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>secrets-store.csi.x-k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>SecretProviderClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>azure-kv-secret-store-csi-mount-env-var</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>azure</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>parameters</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>keyvaultName</span>: <span style=color:#e6db74>&#34;kv-secret-store-csi-001&#34;</span> <span style=color:#75715e># the name of the KeyVault</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tenantId</span>: <span style=color:#e6db74>&#34;328214bc-e88f-43fb-bad1-8f64ff51d823&#34;</span> <span style=color:#75715e># the tenant ID of the KeyVault</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>objects</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      array:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        - |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectName: mysupersecret
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectAlias: mysupersecretalias      # [OPTIONAL available for version &gt; 0.0.4] object alias
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectType: secret              # object types: secret, key or cert. For Key Vault certificates, refer to https://azure.github.io/secrets-store-csi-driver-provider-azure/configurations/getting-certs-and-keys/ for the object type to use
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          objectVersion: &#34;&#34;               # [OPTIONAL] object versions, default to latest if empty</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#f92672>secretObjects</span>: <span style=color:#75715e># [OPTIONAL] SecretObjects defines the desired state of synced Kubernetes secret objects</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>secret-created-automatically</span> <span style=color:#75715e># name of the Kubernetes secret object</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Opaque</span> <span style=color:#75715e># type of Kubernetes secret object (for example, Opaque, kubernetes.io/tls)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>mysupersecret</span> <span style=color:#75715e># data field to populate</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>objectName</span>: <span style=color:#ae81ff>mysupersecretalias</span> <span style=color:#75715e># this could be the object name or the object alias</span>
</span></span></code></pre></div><p>Desplegamos un Pod configurando el secreto como una variable de entorno:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>busybox-secrets-store-mount-env-var</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>busybox</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>k8s.gcr.io/e2e-test-images/busybox:1.29</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;/bin/sleep&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;10000&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>SECRET_CREDENTIALS</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>secretKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secret-created-automatically</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>mysupersecret</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-inline</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/mnt/secrets-store&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-inline</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>csi</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>secrets-store.csi.k8s.io</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeAttributes</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>secretProviderClass</span>: <span style=color:#e6db74>&#34;azure-kv-secret-store-csi-mount-env-var&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>nodePublishSecretRef</span>: <span style=color:#75715e># Only required when using service principal mode</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>secrets-store-creds</span> <span style=color:#75715e># Only required when using service principal mode. The name of the Kubernetes secret that contains the service principal credentials to access keyvault.</span>
</span></span></code></pre></div><p>Ejecutamos el siguiente comando para comprobar el contenido de la variable de entorno:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl exec busybox-secrets-store-mount-env-var -n myapp -- env | grep SECRET_CREDENTIALS
</span></span></code></pre></div><p><img alt="Resultado ejecución &lsquo;kubectl exec busybox-secrets-store-mount-env-var -n myapp &ndash; env | grep SECRET_CREDENTIALS&rsquo;. Muestra &lsquo;MyVaultValueSecret&rsquo;" loading=lazy src=/2022/kubernetes/secrets-store-csi-driver-provider-azure-result-mount-env-var.png></p><h3 id=rotación-de-secretos>Rotación de secretos<a hidden class=anchor aria-hidden=true href=#rotación-de-secretos>#</a></h3><p><strong>Azure Key Vault Provider Secret Store CSI Driver</strong> puede actualizar el valor de un secreto en el caso de que haya sido actualizado en el Azure Key Vault. Actualmente es una funcionalidad en estado alpha, para poder hacer uso de ella debemos habilitarla a través del parámetro <code>secrets-store-csi-driver.enableSecretRotation</code>.</p><p>Esta funcionalidad tiene algunas limitaciones como por ejemplo que no actualiza correctamente el valor de los secretos en Kubernetes (<a href=https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/1007%29>https://github.com/Azure/secrets-store-csi-driver-provider-azure/issues/1007)</a>.</p><h3 id=métricas>Métricas<a hidden class=anchor aria-hidden=true href=#métricas>#</a></h3><p><strong>Azure Key Vault Provider for Secrets Store CSI Driver</strong> nos ofrece diferentes métricas que podemos integrar con <a href=https://prometheus.io/>Prometheus</a>.</p><p>Para Poder consultar las métricas del componente <strong><code>Azure Key Vault Provider</code></strong> ejecuta el siguiente comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward -n kube-system ds/csi-csi-secrets-store-provider-azure 8898:8898 &amp; curl localhost:8898/metrics
</span></span></code></pre></div><p><img alt="Resultado ejecución &lsquo;kubectl port-forward -n kube-system ds/csi-csi-secrets-store-provider-azure 8898:8898 & curl localhost:8898/metrics&rsquo;. Muestra diferentes metricas" loading=lazy src=/2022/kubernetes/secrets-store-csi-driver-provider-azure-result-metrics-csi-csi-secrets-store-provider-azure.png></p><p>Para poder consultar las métricas del componente <strong><code>Secrets Store CSI Driver</code></strong> ejecuta el siguiente comando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl port-forward -n kube-system ds/secrets-store-csi-driver 8080:8080 &amp; curl http://localhost:8080/metrics
</span></span></code></pre></div><p><img alt="Resultado ejecución &lsquo;kubectl port-forward -n kube-system ds/secrets-store-csi-driver 8080:8080 & curl http://localhost:8080/metrics&rsquo;. Muestra diferentes metricas" loading=lazy src=/2022/kubernetes/secrets-store-csi-driver-provider-azure-result-metrics-secrets-store-csi-driver.png></p><p>Puedes encontrar una descripción completa de todas las metricas en el siguiente enlace: <a href=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics>https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics</a></p><blockquote><p>Los nombres de los daemon set y puertos pueden variar dependiendo de los parámetros de configuración.</p></blockquote><h2 id=referencias>Referencias<a hidden class=anchor aria-hidden=true href=#referencias>#</a></h2><ul><li><a href=https://github.com/container-storage-interface>https://github.com/container-storage-interface</a></li><li><a href=https://kubernetes-csi.github.io/docs/>https://kubernetes-csi.github.io/docs/</a></li><li><a href=https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/>https://azure.github.io/secrets-store-csi-driver-provider-azure/docs/</a></li><li><a href=https://github.com/aws/secrets-store-csi-driver-provider-aws>https://github.com/aws/secrets-store-csi-driver-provider-aws</a></li><li><a href=https://github.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp>https://github.com/GoogleCloudPlatform/secrets-store-csi-driver-provider-gcp</a></li><li><a href=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics>https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#metrics</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.javivela.dev/tags/kubernetes/>Kubernetes</a></li><li><a href=https://blog.javivela.dev/tags/aks/>Aks</a></li><li><a href=https://blog.javivela.dev/tags/k8s/>K8S</a></li><li><a href=https://blog.javivela.dev/tags/secrets/>Secrets</a></li><li><a href=https://blog.javivela.dev/tags/seguridad/>Seguridad</a></li></ul><nav class=paginav><a class=prev href=https://blog.javivela.dev/posts/2023/dotnet/csharp-11/><span class=title>« Anterior</span><br><span>Novedades en C# 11</span>
</a><a class=next href=https://blog.javivela.dev/posts/2022/devtools/desarrolla-en-un-contenedor/><span class=title>Siguiente »</span><br><span>Mejora la experiencia de desarrollo, desarrolla dentro de un contenedor</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on x" href="https://x.com/intent/tweet/?text=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f&amp;hashtags=Kubernetes%2caks%2ck8s%2csecrets%2cseguridad"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f&amp;title=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS&amp;summary=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS&amp;source=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f&title=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on whatsapp" href="https://api.whatsapp.com/send?text=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS%20-%20https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on telegram" href="https://telegram.me/share/url?text=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS&amp;url=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Azure Key Vault Provider for Secrets Store CSI Driver, leyendo y utilizando información de un Azure Key Vault desde AKS on ycombinator" href="https://news.ycombinator.com/submitlink?t=Azure%20Key%20Vault%20Provider%20for%20Secrets%20Store%20CSI%20Driver%2c%20leyendo%20y%20utilizando%20informaci%c3%b3n%20de%20un%20Azure%20Key%20Vault%20desde%20AKS&u=https%3a%2f%2fblog.javivela.dev%2fposts%2f2022%2fkubernetes%2fazure-key-vault-secret-store-csi%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://blog.javivela.dev/>Javi Vela Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><img decoding=async loading=eager fetchpriority=low src=https://librecounter.org/counter.svg referrerpolicy=unsafe-url style=width:1px;height:1px alt="librecounter image">
<a href=https://librecounter.org/referer/show target=_blank><img src=https://librecounter.org/counter.svg referrerpolicy=unsafe-url>
</a>referrerPolicy="unsafe-url" style="width: 1px;height: 1px;" />
referrerPolicy="unsafe-url" style="width: 1px;height: 1px;" alt="librecounter image"/>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copiar";function s(){t.innerHTML="¡copiado!",setTimeout(()=>{t.innerHTML="copiar"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>